require("../../common/vendor.js"),(global.webpackJsonp=global.webpackJsonp||[]).push([["pages/tickets/buytickets/select/select"],{"214c":function(e,t,n){n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){return a}));var a={topBar:function(){return Promise.all([n.e("common/vendor"),n.e("pages/components/top-bar/index")]).then(n.bind(null,"6ebb"))},uniPopup:function(){return n.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(n.bind(null,"27c0"))}},o=function(){var e=this,t=(e.$createElement,e._self._c,e.dateListBackUp.length),n=t>0&&e.name?e.selectDate&&e.schedules.length>0:null,a=t>0?e.isTicketSelect&&e.ticketsTypeLists.length>0:null;e.$mp.data=Object.assign({},{$root:{g0:t,g1:n,g2:a}})},s=[]},"230f":function(e,t,n){n.r(t);var a=n("dffc"),o=n.n(a);for(var s in a)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(s);t.default=o.a},a111:function(e,t,n){n.r(t);var a=n("214c"),o=n("230f");for(var s in o)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(s);n("b690");var c=n("f0c5"),i=Object(c.a)(o.default,a.b,a.c,!1,null,"cacfc99c",null,!1,a.a,void 0);t.default=i.exports},ca72:function(e,t,n){(function(e,t){var a=n("4ea4");n("6cdc"),a(n("66fd"));var o=a(n("a111"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(o.default)}).call(this,n("bc2e").default,n("543d").createPage)},dffc:function(e,t,n){(function(e,a){var o=n("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=o(n("2eee")),c=o(n("9523")),i=o(n("c973")),r=n("4dcf"),l=n("fc36"),u=o(n("a78c")),d=n("f1c8"),f=o(n("2ef0")),m=n("3a85"),h=n("b35a");function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){(0,c.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var y=null,v="Um_Event_DateButtonClick",k="Um_Event_DateQuantityPageView";t.default={components:{calendar:function(){Promise.all([n.e("pages/tickets/common/vendor"),n.e("pages/tickets/components/calendar/calendar")]).then(function(){return resolve(n("7a9f"))}.bind(null,n)).catch(n.oe)},ticketCheckModal:function(){Promise.all([n.e("pages/tickets/common/vendor"),n.e("pages/tickets/components/ticket-check-modal/index")]).then(function(){return resolve(n("4f70"))}.bind(null,n)).catch(n.oe)}},data:function(){return{parkId:"",height:"",source:"",hideModal:!0,info:{subscribe_limit:5},name:"",openTime:"",endTime:"",dateMap:{},schedules:[],selectDate:"",selectTimeIndex:-1,dateListBackUp:[],dateList:[],isTicketSelect:!1,ticketsTypeLists:[],selectNum:0,notice:"",filtercalendar:"",currentDate:new Date,isTodayHaltSales:"F",pageMeta:{name:"选择日期和数量页",category:"推荐",type:"填写页",column:"购票约展",plate:"信息填写"},noticeData:{title:"购票提醒",content:""}}},onLoad:function(t){var n=this;return(0,i.default)(s.default.mark((function o(){var c,i,r,l,u;return s.default.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return console.log(t,"******pages onload options*******"),c=n.systemInfo,i=c.statusBarHeight,r=c.system,l=/ios/i.test(r)?44:46,e.createSelectorQuery().select("#reserve-footer").boundingClientRect((function(e){console.log(e,"res");var t=e.height,o=a.getSystemInfoSync().windowHeight-l-i-t;console.log(o,"height"),n.height=o})).exec(),a.showLoading({title:"加载中"}),o.next=8,n.init(t);case 8:return o.next=10,(0,m.getTicketTip)();case 10:"T"===(u=o.sent).open&&(n.noticeData.content='<div style="margin-top: 16px;text-align: center;">'.concat(u.tips,"</div>"));case 12:case"end":return o.stop()}}),o)})))()},onShow:function(){y=new Date,console.log("onShow",y)},onUnload:function(){var e=new Date-y;console.log("onUnload",e,this.source,k),this.handleCommonUma(k,{Um_Key_Duration:e})},onHide:function(){var e=new Date-y;console.log("onHide",e,this.source,k),this.handleCommonUma(k,{Um_Key_Duration:e})},methods:{init:function(e){var t=this;return(0,i.default)(s.default.mark((function n(){var a,o,c,i,r;return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t.getParkInfo(),a=e.source,t.source=a||"normal",o=d.NAME_MAP[t.source],t.parkId=o,c=6,i="",n.next=9,(0,h.getCanBuyDays)({});case 9:(r=n.sent)&&(console.log(r,"canBuyDays"),r.days&&(c=r.days),r.timestamp&&(i=r.timestamp),r.time&&(t.currentDate=r.time.split(" ")[0])),t.getReserveDays(c,i),"year"===t.source&&(v="Um_Event_YearTicketDateButtonClick",k="Um_Event_YearTicketDatePageView");case 13:case"end":return n.stop()}}),n)})))()},getParkInfo:function(){var e=this;return(0,i.default)(s.default.mark((function t(){var n,a,o,c,i;return s.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,h.getMerchantParkInfo)({id:d.PARK_ID_MAIN});case 2:n=t.sent,console.log(n,"parkInfo"),a=n.nickName,o=n.openTime,c=n.endTime,i=n.isTodayHaltSales,e.name=a,e.openTime=o,e.endTime=c,e.isTodayHaltSales=i;case 9:case"end":return t.stop()}}),t)})))()},getReserveDays:function(e,t){var n=[];console.log(e,t,"curTime"),t=Number(t)||(new Date).getTime(),console.log(t,"curTime");for(var a=0;a<=e;a++){var o=this.$dayjs(t+864e5*a).format("YYYYMMDD"),s=this.$dayjs(t+864e5*a).format("YYYY-MM-DD");n.push({date:o,time:s,status:"可订",disabled:!1})}console.log(n,"canBuyDays"),this.dateList=n,this.getSaleStatusCalendar(e,t)},getSaleStatusCalendar:function(e,t){var n=this;return(0,i.default)(s.default.mark((function a(){var o,c,i,r,l,u,d,m,h,p;return s.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return o=n.dateList,c=o[0].date.slice(0,6),i=o[f.default.size(o)-1].date.slice(0,6),console.log(c,i,"fromMonth"),r=[],a.next=7,n.getTimeReserveList(c);case 7:if(r=a.sent,console.log(r,"当月calendar"),l=!r.length,u=!1,c==i){a.next=18;break}return a.next=14,n.getTimeReserveList(i);case 14:d=a.sent,u=f.default.isEmpty(d),r=r.concat(d),console.log(r,"次月calendar");case 18:if(l||u){for(m=0;m<o.length;m++)o[m].status="",o[m].disabled="true";n.dateList=o}h="",f.default.forEach(r,(function(e,t){e.occDate===o[0].time&&(h=t)})),p=f.default.filter(r,(function(t,n){return n>=h&&n<=h+e})),n.filtercalendar=p,console.log(n.filtercalendar,"canBuyDays"),console.log(p,"filtercalendar"),console.log(o,"dateList"),f.default.forEach(p,(function(e,t){if("F"===(null==e?void 0:e.saleStatus))console.log(e.saleStatus,"value.saleStatus"),o[t].status="闭馆",o[t].disabled=!0;else if(0===t)console.log(n.isTodayHaltSales,"this.isTodayHaltSales"),"F"===n.isTodayHaltSales?o[t].status="停售":"T"===n.isTodayHaltSales&&(o[t].status="已闭馆"),o[t].disabled=!0;else{f.default.every(e.parkFsyyDetailDTOS,(function(e){return 0===e.stockNum}))?(o[t].status="约满",o[t].disabled=!0):null!=e&&e.remainingDesc&&(o[t].remainingDesc=e.remainingDesc)}})),n.handleReserveDays(o,t);case 28:case"end":return a.stop()}}),a)})))()},handleReserveDays:function(e,t){console.log(e,"days"),this.dateMap=(0,r.groupBy)(e,"date");var n=this.dateMap;console.log(n,"dateMap");var o=["周日","周一","周二","周三","周四","周五","周六"],s=[];console.log(t,"curTime");for(var c=0;c<3;c++){var i=this.$dayjs(t+864e5*c).format("YYYY-MM-DD"),l=this.$dayjs(t+864e5*c).format("YYYYMMDD"),u=i.split("-"),d=o[new Date(i).getDay()];0===c?d="今天":1===c&&(d="明天");var f=n[l]?n[l][0]:{};console.log(f,"other"),s.push(g({date:i,formatDate:"".concat(u[1],"月").concat(u[2],"日"),week:d,status:"",disabled:!0},f))}this.dateListBackUp=s,a.hideLoading({noConflict:!0})},showDataModal:function(){console.log("指定日期"),this.handleCommonUma(v,{Um_Key_ButtonName:"指定日期"}),console.log(1,this.dateMap),this.hideModal=!1},closeModal:function(){this.hideModal=!0},onSelectData:function(e){if(console.log("xuanze",e),console.log("选择日期"),this.handleCommonUma(v,{Um_Key_ButtonName:"选择日期"}),e.disabled)a.showToast({title:"请重新选择可订日期",icon:"none"});else{if(e.date===this.selectDate)this.selectDate="";else{var t=this.dateListBackUp,n=t,o=t.filter((function(t){return t.date===e.date}));console.log(o,"result"),o.length||(n=t.slice(0,2)).push({date:e.date,week:this.getWeekByDate(e.date),formatDate:this.getDayByDate(e.date),status:"可订",remainingDesc:e.remainingDesc}),this.selectDate=e.date,this.dateListBackUp=n,console.log("分时库存查询"),this.timeReserveList()}this.selectTimeIndex=-1,this.selectNum=0,this.isTicketSelect=!1,this.hideModal=!0,this.ticketsTypeLists=[]}},timeReserveList:function(e){var t=this;return(0,i.default)(s.default.mark((function e(){var n,a,o;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.filtercalendar,a=s.default.mark((function e(){var a,c,i;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.$dayjs(n[o].occDate).format("YYYYMMDD"),console.log(a,"occDate"),a===t.selectDate&&(console.log(a,"occDate"),console.log(n[o],"calendar[c]"),c=n[o].parkFsyyDetailDTOS,i=[],f.default.forEach(c,(function(e){i.push({num:e.stockNum,remainingDesc:e.remainingDesc,title:e.fsTimeName,fsTimeRange:e.fsTimeRange,fsTimeRangeVal:e.fsTimeRange.replace(" ~ ","-")})})),console.log(i,"schedules"),t.schedules=i);case 3:case"end":return e.stop()}}),e)})),o=0;case 3:if(!(o<n.length)){e.next=8;break}return e.delegateYield(a(),"t0",5);case 5:o++,e.next=3;break;case 8:case"end":return e.stop()}}),e)})))()},getTimeReserveList:function(e){var t=this;return(0,i.default)(s.default.mark((function n(){var a,o;return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a={},e&&(a.year=e.slice(0,4),a.month=e.slice(4,6)),n.next=4,(0,m.getMallChantCalendar)(g({parkId:t.parkId},a));case 4:return o=n.sent,console.log(o,"getMallChantCalendar"),n.abrupt("return",o);case 7:case"end":return n.stop()}}),n)})))()},onModalSelectDate:function(e){this.onSelectData(e)},onSelectTime:function(e,t){console.log("选择场次"),this.handleCommonUma(v,{Um_Key_ButtonName:"选择场次"}),void 0!==t.title&&t.title&&(t.num&&this.selectTimeIndex!==e?(a.showLoading({title:"加载中",mask:!0}),this.selectTimeIndex=e,this.isTicketSelect=!0,this.selectNum=0,this.ticketsTypeLists=[],this.getTicketsTypeByDate(t)):console.log(this.selectTimeIndex,e))},getTicketsTypeByDate:function(e){var t=this;return(0,i.default)(s.default.mark((function n(){var a,o,c,i;return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return a=t.$dayjs(t.selectDate).format("YYYY-MM-DD"),console.log(a,"stime"),n.next=4,(0,m.getChantParkTicketList)({date:a,merchantParkInfoId:t.parkId});case 4:o=n.sent,c=o.ticketList,console.log(c,"ticketsTypeLists"),i=[],"year"===t.source?c=f.default.filter(c,(function(e){return f.default.eq(e.ticketType,"9")})):"normal"===t.source&&(c=f.default.filter(c,(function(e){return!f.default.eq(e.ticketType,"9")}))),f.default.forEach(c,(function(e){e.data=0;var t={};t.modelCode=e.modelCode,t.externalCode=e.externalCode,t.startTime=a,t.endTime=a,i.push(t)})),t.getTicketsStatus(e,i,c);case 11:case"end":return n.stop()}}),n)})))()},getTicketsStatus:function(e,t,n){var o=this;return(0,i.default)(s.default.mark((function c(){var i,r,l,u,d,h;return s.default.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return i=e.fsTimeRange.split(" ~ "),r=i[0],l=i[1],console.log(t,"queryParam"),s.next=6,(0,m.getMallBatchTimeReserveList)({queryParam:t});case 6:u=s.sent,d=[],console.log(u,"ticketLists"),f.default.forEach(u,(function(e){var t=e.fsList;f.default.forEach(t,(function(t){t.startTime===r&&t.endTime===l&&d.push(g(g({},t),{},{modelCode:e.modelCode}))}))})),h=[],f.default.forEach(n,(function(e){f.default.forEach(d,(function(t){if(e.modelCode===t.modelCode){var n=g(g({},t),e);h.push(n)}}))})),console.log(h,"newTicketsTypeLists"),o.ticketsTypeLists=h,a.hideLoading({noConflict:!0});case 15:case"end":return s.stop()}}),c)})))()},addTicketsNum:function(e,t){console.log("添加门票数量"),this.handleCommonUma(v,{Um_Key_ButtonName:"添加门票数量"}),this.selectNum>=this.info.subscribe_limit||e.num<=0||(this.$set(this.ticketsTypeLists[t],"data",e.data+1),this.selectNum=this.selectNum+1)},delTicketsNum:function(e,t){console.log("减少门票数量"),this.handleCommonUma(v,{Um_Key_ButtonName:"减少门票数量"}),0!=e.data&&(this.$set(this.ticketsTypeLists[t],"data",e.data-1),this.selectNum=this.selectNum-1)},onConfirm:function(){var e=this;return(0,i.default)(s.default.mark((function t(){var n,o,c,i,r,d;return s.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.log("立即预定"),e.handleCommonUma(v,{Um_Key_ButtonName:"立即预定"}),n=e.selectDate,o=e.selectTimeIndex,c=e.selectNum,n){t.next=6;break}return a.showToast({title:"请选择预约日期",icon:"none"}),t.abrupt("return");case 6:if(-1!==o){t.next=9;break}return a.showToast({title:"请选择预约时间",icon:"none"}),t.abrupt("return");case 9:if(0!=c){t.next=12;break}return a.showToast({title:"请选择门票数量",icon:"none"}),t.abrupt("return");case 12:for(i=[],r=e.ticketsTypeLists,d=0;d<r.length;d++)r[d].data>0&&i.push(r[d]);console.log(i,"tickets"),u.default.set(i,"selectTicketList"),u.default.set(e.selectDate,"selectDate"),u.default.set(e.schedules[e.selectTimeIndex].title,"selectSchedule"),(0,l.navigateTo)(l.PAGE_PATH.TICKETS_PERSON,{source:e.source,name:e.source});case 20:case"end":return t.stop()}}),t)})))()},openNotice:function(e){console.log("购买须知"),this.handleCommonUma(v,{Um_Key_ButtonName:"购买须知"}),this.notice=e,this.$refs.popupNotice.open("bottom")},closeNotice:function(){console.log("关闭公告弹框"),this.handleCommonUma(v,{Um_Key_ButtonName:"关闭购买须知"}),this.$refs.popupNotice.close()},getWeekByDate:function(e){return["周日","周一","周二","周三","周四","周五","周六"][this.$dayjs(e).format("d")]},getDayByDate:function(e){var t=e.slice(4,6),n=e.slice(6,8);return"".concat(t,"月").concat(n,"日")}}}}).call(this,n("543d").default,n("bc2e").default)}},[["ca72","common/runtime","common/vendor","pages/tickets/common/vendor"]]]);