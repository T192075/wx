require("../../common/vendor.js"),(global.webpackJsonp=global.webpackJsonp||[]).push([["pages/tickets/buytickets/person/person"],{"19c7":function(e,t,n){(function(e,r){var o=n("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=o(n("2eee")),s=o(n("448a")),c=o(n("c973")),i=o(n("9523")),u=n("26cb"),l=o(n("5a0c")),d=n("f2d7"),h=o(n("a78c")),f=n("fc36"),p=n("a887"),m=n("3a85"),v=n("b35a"),g=n("f1c8"),k=o(n("2ef0"));function D(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function C(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?D(Object(n),!0).forEach((function(t){(0,i.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):D(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var y=[],b=!1,T="Um_Event_InformationButtonClick",w="Um_Event_InformationPageView",x=null,P=!1;t.default={components:{TicketNoticeModal:function(){Promise.all([n.e("pages/tickets/common/vendor"),n.e("pages/tickets/components/ticket-notice-modal/index")]).then(function(){return resolve(n("df6e"))}.bind(null,n)).catch(n.oe)}},data:function(){return{height:"",source:"",info:{},selectDate:"",selectSchedule:"",person:[],ticketsTypeLists:[],reserveData:[],selectNum:5,phoneError:!1,phone:"",allIn:!1,savePersons:[],cardList:[],currentPersonIndex:"",checkList:[],passed:!1,staffPhoneList:[],passImage:"".concat(g.COS_PATH,"/success.png"),failImage:"".concat(g.COS_PATH,"/fail.png"),errorMessage:"",cursorSpacing:"20",showBottom:!0,inputDisable:!1,showOftenUse:!1,noticeData:{},showNoticeModal:!1,pageMeta:{name:"填写观众信息页",category:"推荐",type:"填写页",column:"购票约展",plate:"信息填写"}}},computed:C({},(0,u.mapGetters)({buyer:"getMallBuyerData"})),onLoad:function(t){var n=this;return(0,c.default)(a.default.mark((function o(){var s,c,i,u;return a.default.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return console.log(t,"******pages onload options*******"),e.showLoading({title:"加载中"}),s=n.systemInfo,c=s.statusBarHeight,i=s.system,u=/ios/i.test(i)?44:46,r.createSelectorQuery().select("#reserve-footer").boundingClientRect((function(t){console.log(t,"res");var r=t.height,o=e.getSystemInfoSync().windowHeight-u-c-r;console.log(o,"height"),n.height=o})).exec(),o.next=8,n.init(t);case 8:e.hideLoading({noConflict:!0});case 9:case"end":return o.stop()}}),o)})))()},onShow:function(){x=new Date,console.log("onShow",x)},onHide:function(){var e=new Date-x;console.log("onHide",e,this.source,w),this.handleCommonUma(w,{Um_Key_Duration:e})},methods:C(C({},(0,u.mapActions)(["pluginReserveData","pluginMallLoginGetToken"])),{},{init:function(e){var t=this;return(0,c.default)(a.default.mark((function n(){var r,o,s,c,i,u,l,d,f;return a.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=e.source,o=e.name,t.source=r,s=g.NAME_MAP[o]||g.PARK_ID_MAIN,t.parkId=s,c=[],i=h.default.get("selectTicketList"),u=h.default.get(s+"_selectTicketList")||[],console.log(s,"parkId"),console.log(u,"storeTicketList"),t.ticketsTypeLists=i,l=[],d=0,k.default.forEach(i,(function(e){var t=e.nickName,n=e.price,r=e.modelCode,o=e.isRealName,a=e.itemId,s=e.endTime,c=e.startTime,i=e.stockCode;d+=e.data;for(var u=0;u<e.data;u++)l.push({nickName:t,cardTypes:e.cardType,price:n,modelCode:r,isRealName:o,selectCardType:{id:0,name:"身份证"},itemId:a,endTime:s,startTime:c,stockCode:i})})),k.default.size(u)>0?k.default.forEach(l,(function(e){var t=k.default.findIndex(u,(function(t){return t.nickName===e.nickName}));-1!=t?(c.push(C(C({},u[t]),{},{startTime:e.startTime,endTime:e.endTime})),u.splice(t,1)):c.push(e)})):c=l,t.selectNum=d,t.reserveData=c,t.selectDate=h.default.get("selectDate"),t.selectSchedule=h.default.get("selectSchedule"),t.getContactsList(),t.phone=t.buyer.phoneNumber,f=h.default.get(s+"_selectTicketList"),console.log(k.default.size(f)),k.default.size(f)>0&&t.handleCheckAllIn(),"year"===t.source&&(T="Um_Event_YearTicketInforButtonClick",w="Um_Event_YearTicketInforPageView");case 24:case"end":return n.stop()}}),n)})))()},onUnload:function(){var e=this.reserveData;k.default.forEach(e,(function(e,t){e.showSave=void 0,e.cardError=void 0,e.nameError=void 0,e.showYearInfo=void 0})),console.log("缓存用户信息",this.reserveData,this.parkId+"_selectTicketList"),h.default.set(e,this.parkId+"_selectTicketList");var t=new Date-x;this.handleCommonUma(w,{Um_Key_Duration:t})},getContactsList:function(){var e=this;return(0,c.default)(a.default.mark((function t(){var n;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,p.getMallContactsList)();case 2:200==(n=t.sent).code&&(n=n.data),console.log(n,"list"),k.default.forEach(n,(function(e,t){console.log(e,"value");var n=k.default.find(g.ID_TYPE,{id:e.type});e.cardType=n})),console.log(n,"list"),e.savePersons=n,y=n;case 9:case"end":return t.stop()}}),t)})))()},showSavePersons:function(e){this.showBottom=!1;var t=this.reserveData,n=y.filter((function(e){return t.every((function(t){return t.idCard!=e.idCard}))}));k.default.size(n)>0&&(this.showOftenUse=!0,console.log(e,"index"),this.savePersons=n,this.$set(this.reserveData[e],"showSave",!0))},hideSavePersons:function(e){this.$set(this.reserveData[e],"showSave",!1),this.showOftenUse=!1},selectSaveUser:function(e,t,n){b=!0,console.log(n,"item","选择常用游客信息"),console.log(t,"index","选择常用游客信息"),this.$set(this.reserveData[e],"idCard",n.idCard),this.$set(this.reserveData[e],"selectCardType",n.cardType),this.$set(this.reserveData[e],"showSave",!1),this.$set(this.reserveData[e],"cardError",!1),this.$set(this.reserveData[e],"nameError",!1),this.$set(this.reserveData[e],"userName",n.name),"year"===this.source&&this.checkYearUser(!0,n.cardType.id,n.idCard,e)},checkName:function(e){if(b){var t=this.reserveData[e].userName;this.$set(this.reserveData[e],"name",t)}this.handleCheckAllIn("name",this.reserveData[e].name,e)},getDayByDate:function(e){var t=e.slice(0,4),n=e.slice(4,6),r=e.slice(6,8);return"".concat(t,"年").concat(n,"月").concat(r,"日")},handleCheckAllIn:function(e,t,n){var r=this;return(0,c.default)(a.default.mark((function o(){var s,c,i,u,l,h,f,p,m;return a.default.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(r.showBottom=!0,console.log("handleCheckAllIn",e,t),s=!0,c=r.reserveData,console.log(c," 选择之后的reserveData"),"phone"!==e){o.next=11;break}i=r.checkPhoneInput(t),console.log(i,"checkPhone"),i||(s=!1),o.next=21;break;case 11:if("card"!==e){o.next=20;break}return o.next=14,r.checkCardInput(t.selectCardType.id,t.idCard,n);case 14:u=o.sent,(l=t.idCard)&&k.default.endsWith(l,"x")&&(console.log("身份证X转大写"),t.idCard=(0,d.xToUpperCase)(t.idCard)),u||(s=!1),o.next=21;break;case 20:"name"===e&&(setTimeout((function(){r.hideSavePersons(n)}),100),console.log(b,"clickUserFlag"),b?b=!1:(h=r.checkNameInput(t,n),console.log(h,t,"checkName"),h||(s=!1)));case 21:if(r.phone||(s=!1),!s){o.next=45;break}console.log("校验全局"),f=0;case 25:if(!(f<c.length)){o.next=45;break}if(c[f].name&&c[f].idCard&&r.phone){o.next=31;break}return s=!1,o.abrupt("continue",42);case 31:return console.log("是否都校验通过"),o.next=34,r.checkCardInput(c[f].selectCardType.id,c[f].idCard,f);case 34:if(p=o.sent,m=r.checkNameInput(c[f].name,f),p){o.next=39;break}return s=!1,o.abrupt("continue",42);case 39:if(m){o.next=42;break}return s=!1,o.abrupt("continue",42);case 42:f++,o.next=25;break;case 45:r.allIn=s,console.log(r.allIn,"allIn");case 47:case"end":return o.stop()}}),o)})))()},checkCardInput:function(e,t,n){var r=this;return(0,c.default)(a.default.mark((function o(){var s;return a.default.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(console.log(e,"cardType","证件类型id"),s=!0,0===e?s=(0,d.checkIdcard)(t):void 0!==t&&""!==t.trim()||(s=!1),console.log(s,"check"),r.$set(r.reserveData[n],"cardError",!s),"year"!==r.source){o.next=13;break}if(!s){o.next=12;break}return o.next=9,r.checkYearUser(s,e,t,n);case 9:s=o.sent,o.next=13;break;case 12:r.$set(r.reserveData[n],"showYearInfo",!1);case 13:return console.log(s,"check年票校验"),o.abrupt("return",s);case 15:case"end":return o.stop()}}),o)})))()},checkYearUser:function(e,t,n,r){var o=this;return(0,c.default)(a.default.mark((function s(){var c;return a.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,(0,m.getVerifiyYearCard)({certNo:n,certType:t,tradeDate:o.getTextByDate(o.selectDate)});case 2:return c=a.sent,console.log(t,"cardType"),console.log(c,"getVerifiyYearCard"),1===c.yearCardType?(o.$set(o.reserveData[r],"roleError",!1),o.$set(o.reserveData[r],"totalNum",c.totalNum),o.$set(o.reserveData[r],"hasNum",c.totalNum-c.canUseNum),console.log("年票用户"),0===c.canUseNum&&(e=!1)):2===c.yearCardType?(o.$set(o.reserveData[r],"roleError",!0),e=!1):void 0===c.yearCardType&&(e=!1),o.$set(o.reserveData[r],"showYearInfo",!0),console.log(e,"check年票校验"),a.abrupt("return",e);case 9:case"end":return a.stop()}}),s)})))()},checkPhoneInput:function(e){var t=!0;return console.log(e,"phone"),(0,d.checkPhone)(e)?this.phoneError=!1:(t=!1,this.phoneError=!0),t},checkNameInput:function(e,t){var n=!0;return console.log(e,"name"),void 0===e||""===e.trim()?(this.$set(this.reserveData[t],"nameError",!0),n=!1):this.$set(this.reserveData[t],"nameError",!1),n},onConfirm:function(){var e=this;return(0,c.default)(a.default.mark((function t(){var n;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=P,P=!0,!n){t.next=4;break}return t.abrupt("return");case 4:return console.log("确认"),e.handleCommonUma(T,{Um_Key_ButtonName:"确认"}),t.next=8,e.handleCheckAllIn();case 8:if(!e.allIn){t.next=11;break}return t.next=11,e.checkToken();case 11:setTimeout((function(){P=!1}),200);case 12:case"end":return t.stop()}}),t)})))()},checkToken:function(){var e=this;return(0,c.default)(a.default.mark((function t(){var n;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,p.getMallLeaguerInfo)();case 2:if(n=t.sent,"{}"!==JSON.stringify(n)){t.next=6;break}return t.next=6,e.pluginMallLoginGetToken();case 6:return t.next=8,e.getTicketVer();case 8:case"end":return t.stop()}}),t)})))()},showChildPop:function(){k.default.find(this.reserveData,{modelCode:"MP2022061714445592241"})?this.getChildRule():this.checkToken()},getTicketVer:function(){var e=this;return(0,c.default)(a.default.mark((function t(){var n,r,o,c,i,u,l,d;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.reserveData,console.log(n,"reserveData"),r=k.default.groupBy(n,"modelCode"),o=[],c=[],e.checkList=[],e.passed=!1,k.default.forEach(r,(function(e,t){var n={certAuthDTOS:[],modelCodesDTOS:[]};k.default.forEach(e,(function(e){var t={};t.cardType=e.selectCardType.id,t.certNo=e.idCard,t.name=e.name,n.certAuthDTOS.push(t)})),n.modelCodesDTOS.modelCode=t,n.modelCodesDTOS.push({modelCode:t,parentModelCode:t}),o.push(n)})),console.log(o,"ticketVerificationDTOS"),console.log(n,"reserveData"),t.next=12,e.pluginReserveData({source:e.source,ticketVerificationDTOS:o,reserveData:n,selectDate:e.getTextByDate(e.selectDate),selectSchedule:e.selectSchedule,phone:e.phone});case 12:i=t.sent,console.log(Object.keys(i),i,"keys"),"string"!=typeof i?(u=i,console.log(u,"list"),u.checkStatus?e.passed=!0:e.passed=!1,l=u.passCertAuthList||[],d=u.rejectCertAuthList||[],console.log(l,d,"rejectCertAuthList"),l&&k.default.size(l)>0&&k.default.forEach(l,(function(e){e.checkCard=!0})),d&&k.default.size(d)>0&&k.default.forEach(d,(function(e){e.checkCard=!1})),c=[].concat((0,s.default)(l),(0,s.default)(d)),console.log(c,"checkList"),e.checkList=c):e.errorMessage=i,e.showBottom=!1,e.inputDisable=!0,e.$refs.popupCheck.open("bottom");case 18:case"end":return t.stop()}}),t)})))()},openPhoneModal:function(){console.log("联系客服"),this.handleCommonUma(T,{Um_Key_ButtonName:"联系客服"}),this.getServerPhone()},getServerPhone:function(){var e=this;return(0,c.default)(a.default.mark((function t(){var n;return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,v.getSysParamByKey)({key:"gugong_customerServiceTel"});case 2:n=t.sent,console.log(n,"getSysParamByKey"),200===n.status&&(e.staffPhoneList=n.message.split(","),e.showBottom=!1,e.inputDisable=!0,e.$refs.popupPhone.open("bottom"));case 5:case"end":return t.stop()}}),t)})))()},getChildRule:function(){var e=this;return(0,c.default)(a.default.mark((function t(){return a.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,v.getModalContentByCodeId)({advertCode:"rules_minors"});case 2:e.noticeData=t.sent,e.showNoticeModal=!0;case 4:case"end":return t.stop()}}),t)})))()},closePhoneModal:function(){this.$refs.popupPhone.close(),this.showBottom=!0,this.inputDisable=!1},callStaffPhone:function(e){r.makePhoneCall({phoneNumber:e}),this.$refs.popupPhone.close(),this.inputDisable=!1,this.showBottom=!0},selectCardlist:function(e){this.showBottom=!1,this.inputDisable=!0;var t=this.reserveData[e].cardTypes.split(",");k.default.isEmpty(this.reserveData[e].idCard)&&(this.reserveData[e].idCard=""),console.log(t,"cardType");var n=[];k.default.forEach(t,(function(e){var t=k.default.find(g.ID_TYPE,{type:e.toUpperCase()});null!=t&&t&&n.push(t)})),this.cardList=n,this.$refs.popupCard.open("bottom"),this.currentPersonIndex=e},onSelectCard:function(e){this.showBottom=!0,this.reserveData[this.currentPersonIndex].selectCardType=e,this.$refs.popupCard.close(),this.inputDisable=!1,this.handleCheckAllIn("card",this.reserveData[this.currentPersonIndex],this.currentPersonIndex)},closeTypePop:function(){this.showBottom=!0,this.$refs.popupCard.close(),this.inputDisable=!1},closeCheckModel:function(){this.showBottom=!0,this.$refs.popupCheck.close(),this.inputDisable=!1},backSelectDate:function(){console.log("修改"),this.handleCommonUma(T,{Um_Key_ButtonName:"修改"}),r.navigateBack()},continuePay:function(){this.passed&&(console.log("下一步"),this.handleCommonUma(T,{Um_Key_ButtonName:"下一步"}),this.showBottom=!0,this.$refs.popupCheck.close(),this.inputDisable=!1,console.log(this.source,"this.source"),"display"===this.source||"room"===this.source?(0,f.navigateTo)(f.PAGE_PATH.TICKETS_CONFIRM_ORDER,{type:"offline"}):(0,f.navigateTo)(f.PAGE_PATH.TICKETS_SELECT_ROOM))},getTextByDate:function(e){return(0,l.default)(e).format("YYYY-MM-DD")},hideBottom:function(){this.showBottom=!1},hideNotice:function(){this.showNoticeModal=!1,this.checkToken()}})}}).call(this,n("bc2e").default,n("543d").default)},"4cbf":function(e,t,n){n.r(t);var r=n("19c7"),o=n.n(r);for(var a in r)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(a);t.default=o.a},7470:function(e,t,n){(function(e,t){var r=n("4ea4");n("6cdc"),r(n("66fd"));var o=r(n("bc8f"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(o.default)}).call(this,n("bc2e").default,n("543d").createPage)},"7d54":function(e,t,n){n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return r}));var r={topBar:function(){return Promise.all([n.e("common/vendor"),n.e("pages/components/top-bar/index")]).then(n.bind(null,"6ebb"))},uniPopup:function(){return n.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(n.bind(null,"27c0"))}},o=function(){var e=this,t=(e.$createElement,e._self._c,e.getDayByDate(e.selectDate)),n=e.__map(e.reserveData,(function(t,n){return{$orig:e.__get_orig(t),g0:t.showSave&&e.savePersons.length>0}})),r=e.checkList.length;e.$mp.data=Object.assign({},{$root:{m0:t,l0:n,g1:r}})},a=[]},bc8f:function(e,t,n){n.r(t);var r=n("7d54"),o=n("4cbf");for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);n("014a");var s=n("f0c5"),c=Object(s.a)(o.default,r.b,r.c,!1,null,"18d80a6e",null,!1,r.a,void 0);t.default=c.exports}},[["7470","common/runtime","common/vendor","pages/tickets/common/vendor"]]]);