require("../../../common/vendor.js"),(global.webpackJsonp=global.webpackJsonp||[]).push([["pages/tickets/buytickets/yearPack/person/person"],{"65ba":function(e,t,r){(function(e,a){var n=r("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=n(r("2eee")),s=n(r("448a")),c=n(r("c973")),i=n(r("9523")),u=r("26cb"),l=r("f2d7"),d=n(r("a78c")),f=r("fc36"),h=r("a887"),p=r("3a85"),m=r("f1c8"),v=n(r("2ef0")),g=n(r("294b"));function k(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?k(Object(r),!0).forEach((function(t){(0,i.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var D=[],T=!1,C=[];t.default={components:{TicketNoticeModal:function(){Promise.all([r.e("pages/tickets/common/vendor"),r.e("pages/tickets/components/ticket-notice-modal/index")]).then(function(){return resolve(r("df6e"))}.bind(null,r)).catch(r.oe)}},data:function(){return{height:"",info:{},selectDate:"",person:[],ticketsTypeLists:[],reserveData:[],selectNum:5,phone:"",allIn:!1,savePersons:[],cardList:[],currentPersonIndex:"",checkList:[],passed:!1,staffPhoneList:[],passImage:"".concat(m.COS_PATH,"/success.png"),failImage:"".concat(m.COS_PATH,"/fail.png"),errorMessage:"",cursorSpacing:"20",showBottom:!0,inputDisable:!1,showOftenUse:!1,noticeData:{},showNoticeModal:!1,disabledButton:!1,pageMeta:{name:"填写观众信息页(购买年票)",category:"推荐",type:"填写页",column:"购票约展",plate:"套票信息填写"}}},computed:y({},(0,u.mapGetters)({buyer:"getMallBuyerData"})),onLoad:function(t){var r=this;return(0,c.default)(o.default.mark((function n(){var s,c,i,u;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r.disabledButton=!1,console.log(t,"******pages onload options*******"),e.showLoading({title:"加载中"}),s=r.systemInfo,c=s.statusBarHeight,i=s.system,u=/ios/i.test(i)?44:46,a.createSelectorQuery().select("#reserve-footer").boundingClientRect((function(t){console.log(t,"res");var a=t.height,n=e.getSystemInfoSync().windowHeight-u-c-a;console.log(n,"height"),r.height=n})).exec(),n.next=9,r.init(t);case 9:e.hideLoading();case 10:case"end":return n.stop()}}),n)})))()},methods:y(y({},(0,u.mapActions)(["pluginReserveData","pluginMallLoginGetToken","pluginMallrequestPayment"])),{},{init:function(e){var t=this;return(0,c.default)(o.default.mark((function r(){var a,n,s,c,i,u,l,f;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:a=e.source,n=e.name,t.source=a,s=m.NAME_MAP[n]||m.PARK_ID_MAIN,t.parkId=s,c=[],C=d.default.get("selectTicketList"),i=d.default.get(s+"_selectTicketList")||[],console.log(s,"parkId"),console.log(i,"storeTicketList"),t.ticketsTypeLists=C,u=[],l=0,v.default.forEach(C,(function(e){var t=e.nickName,r=e.price,a=e.modelCode,n=e.isRealName,o=e.itemId,s=e.endTime,c=e.startTime,i=e.stockCode;l+=e.data;for(var d=0;d<e.data;d++)u.push({nickName:t,cardTypes:e.cardType,price:r,modelCode:a,isRealName:n,selectCardType:{id:0,name:"身份证"},itemId:o,endTime:s,startTime:c,stockCode:i})})),v.default.size(i)>0?v.default.forEach(u,(function(e){var t=v.default.findIndex(i,(function(t){return t.nickName===e.nickName}));-1!=t?(c.push(i[t]),i.splice(t,1)):c.push(e)})):c=u,t.selectNum=l,t.reserveData=c,t.selectDate=d.default.get("selectDate"),t.selectSchedule=d.default.get("selectSchedule"),t.getContactsList(),f=d.default.get(s+"_selectTicketList"),console.log(v.default.size(f)),v.default.size(f)>0&&t.handleCheckAllIn();case 22:case"end":return r.stop()}}),r)})))()},onUnload:function(){var e=this.reserveData;v.default.forEach(e,(function(e,t){e.showSave=void 0,e.cardError=void 0,e.nameError=void 0,e.showYearInfo=void 0})),console.log("缓存用户信息",this.reserveData,this.parkId+"_selectTicketList"),d.default.set(e,this.parkId+"_selectTicketList")},getContactsList:function(){var e=this;return(0,c.default)(o.default.mark((function t(){var r;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,h.getMallContactsList)();case 2:200==(r=t.sent).code&&(r=r.data),console.log(r,"list"),v.default.forEach(r,(function(e,t){console.log(e,"value");var r=v.default.find(m.ID_TYPE,{id:e.type});e.cardType=r})),console.log(r,"list"),e.savePersons=r,D=r;case 9:case"end":return t.stop()}}),t)})))()},showSavePersons:function(e){this.showBottom=!1;var t=this.reserveData,r=D.filter((function(e){return t.every((function(t){return t.idCard!=e.idCard}))}));v.default.size(r)>0&&(this.showOftenUse=!0,console.log(e,"index"),this.savePersons=r,this.$set(this.reserveData[e],"showSave",!0))},hideSavePersons:function(e){this.$set(this.reserveData[e],"showSave",!1),this.showOftenUse=!1},selectSaveUser:function(e,t,r){T=!0,console.log(r,"item","选择常用游客信息"),console.log(t,"index","选择常用游客信息"),this.$set(this.reserveData[e],"idCard",r.idCard),this.$set(this.reserveData[e],"selectCardType",r.cardType),this.$set(this.reserveData[e],"showSave",!1),this.$set(this.reserveData[e],"cardError",!1),this.$set(this.reserveData[e],"nameError",!1),this.$set(this.reserveData[e],"userName",r.name)},checkName:function(e){if(T){var t=this.reserveData[e].userName;this.$set(this.reserveData[e],"name",t)}this.handleCheckAllIn("name",this.reserveData[e].name,e)},getDayByDate:function(e){console.log(e,"date");var t=e.slice(0,4),r=e.slice(5,7),a=e.slice(8,10);return"".concat(t,"年").concat(r,"月").concat(a,"日")},handleCheckAllIn:function(e,t,r){var a=this;return(0,c.default)(o.default.mark((function n(){var s,c,i,u,d,f,h,p,m,g;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a.showBottom=!0,console.log("handleCheckAllIn",e,t),s=!0,c=a.reserveData,console.log(c," 选择之后的reserveData"),"phone"===e?(i=a.checkPhoneInput(t,r),console.log(i,"checkPhone"),i||(s=!1)):"card"===e?(u=a.checkCardInput(t.selectCardType.id,t.idCard,r),(d=t.idCard)&&v.default.endsWith(d,"x")&&(console.log("身份证X转大写"),t.idCard=(0,l.xToUpperCase)(t.idCard)),u||(s=!1)):"name"===e&&(setTimeout((function(){a.hideSavePersons(r)}),100),console.log(T,"clickUserFlag"),T?T=!1:(f=a.checkNameInput(t,r),console.log(f,t,"checkName"),f||(s=!1))),!s){n.next=25;break}console.log("校验全局"),h=0;case 9:if(!(h<c.length)){n.next=25;break}if(c[h].name&&c[h].idCard&&c[h].phone){n.next=15;break}return s=!1,n.abrupt("continue",22);case 15:return console.log("是否都校验通过"),n.next=18,a.checkCardInput(c[h].selectCardType.id,c[h].idCard,h);case 18:p=n.sent,m=a.checkNameInput(c[h].name,h),g=a.checkPhoneInput(c[h].phone,h),p&&m&&g||(s=!1);case 22:h++,n.next=9;break;case 25:a.allIn=s,console.log(a.allIn,"allIn");case 27:case"end":return n.stop()}}),n)})))()},checkCardInput:function(e,t,r){var a=this;return(0,c.default)(o.default.mark((function n(){var s;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log(e,"cardType","证件类型id"),s=!0,0===e?s=(0,l.checkIdcard)(t):void 0!==t&&""!==t.trim()||(s=!1),console.log(s,"check"),a.$set(a.reserveData[r],"cardError",!s),n.abrupt("return",s);case 6:case"end":return n.stop()}}),n)})))()},checkPhoneInput:function(e,t){var r=!0;return console.log(e,"phone"),(0,l.checkPhone)(e)?this.$set(this.reserveData[t],"phoneError",!1):(r=!1,this.$set(this.reserveData[t],"phoneError",!0)),r},checkNameInput:function(e,t){var r=!0;return console.log(e,"name"),void 0===e||""===e.trim()?(this.$set(this.reserveData[t],"nameError",!0),r=!1):this.$set(this.reserveData[t],"nameError",!1),r},onConfirm:function(){var e=this,t=this.reserveData;v.default.forEach(t,(function(t,r){e.checkCardInput(t.selectCardType.id,t.idCard,r),e.checkNameInput(t.name,r),e.checkPhoneInput(t.phone,r)})),this.allIn&&this.checkToken()},checkToken:function(){var e=this;return(0,c.default)(o.default.mark((function t(){var r;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,h.getMallLeaguerInfo)();case 2:if(r=t.sent,"{}"!==JSON.stringify(r)){t.next=6;break}return t.next=6,e.pluginMallLoginGetToken();case 6:e.getTicketVer();case 7:case"end":return t.stop()}}),t)})))()},getTicketVer:function(){var e=this;return(0,c.default)(o.default.mark((function t(){var r,a,n,c,i,u,l,d;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.reserveData,console.log(r,"reserveData"),a=v.default.groupBy(r,"modelCode"),n=[],c=[],e.checkList=[],e.passed=!1,v.default.forEach(a,(function(e,t){var r={certAuthDTOS:[],modelCodesDTOS:[]};v.default.forEach(e,(function(e){var t={};t.cardType=e.selectCardType.id,t.certNo=e.idCard,t.name=e.name,r.certAuthDTOS.push(t)})),r.modelCodesDTOS.modelCode=t,r.modelCodesDTOS.push({modelCode:t,parentModelCode:t}),n.push(r)})),console.log(n,"ticketVerificationDTOS"),console.log(r,"reserveData"),t.next=12,e.pluginReserveData({source:e.source,ticketVerificationDTOS:n,reserveData:r,selectDate:e.getTextByDate(e.selectDate),selectSchedule:e.selectSchedule,phone:e.phone});case 12:"string"!=typeof(i=t.sent)?(u=i,console.log(u,"list"),u.checkStatus?e.passed=!0:e.passed=!1,l=u.passCertAuthList||[],d=u.rejectCertAuthList||[],console.log(l,d,"rejectCertAuthList"),l&&v.default.size(l)>0&&v.default.forEach(l,(function(e){e.checkCard=!0})),d&&v.default.size(d)>0&&v.default.forEach(d,(function(e){e.checkCard=!1})),c=[].concat((0,s.default)(l),(0,s.default)(d)),console.log(c,"checkList"),e.checkList=c):e.errorMessage=i,e.showBottom=!1,e.inputDisable=!0,e.$refs.popupCheck.open("bottom");case 17:case"end":return t.stop()}}),t)})))()},selectCardlist:function(e){this.showBottom=!1,this.inputDisable=!0;var t=this.reserveData[e].cardTypes.split(",");v.default.isEmpty(this.reserveData[e].idCard)&&(this.reserveData[e].idCard=""),console.log(t,"cardType");var r=[];v.default.forEach(t,(function(e){var t=v.default.find(m.ID_TYPE,{type:e.toUpperCase()});null!=t&&t&&r.push(t)})),this.cardList=r,this.$refs.popupCard.open("bottom"),this.currentPersonIndex=e},onSelectCard:function(e){this.showBottom=!0,this.reserveData[this.currentPersonIndex].selectCardType=e,this.$refs.popupCard.close(),this.inputDisable=!1,this.handleCheckAllIn("card",this.reserveData[this.currentPersonIndex],this.currentPersonIndex)},closeTypePop:function(){this.showBottom=!0,this.$refs.popupCard.close(),this.inputDisable=!1},closeCheckModel:function(){this.showBottom=!0,this.$refs.popupCheck.close(),this.inputDisable=!1},continuePay:function(){var e=this;return(0,c.default)(o.default.mark((function t(){return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.passed){t.next=11;break}return e.showBottom=!0,e.$refs.popupCheck.close(),e.inputDisable=!1,console.log(e.reserveData[0],"this.reserveData[0];"),t.next=7,e.getTicketsStatus();case 7:if(!t.sent){t.next=10;break}return t.abrupt("return");case 10:e.handleSubmitOrder();case 11:case"end":return t.stop()}}),t)})))()},getTicketsStatus:function(){var t=this;return(0,c.default)(o.default.mark((function r(){var a,n,s,c,i,u;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=[],n={},s=C[0],n.modelCode=s.modelCode,n.externalCode=s.externalCode,n.startTime=t.selectDate,n.endTime=t.selectDate,a.push(n),r.next=10,(0,p.getMallBatchTimeReserveList)({queryParam:a});case 10:if(c=r.sent,i=[],console.log(c,"ticketLists"),v.default.forEach(c,(function(e){var t=e.fsList;v.default.forEach(t,(function(t){i.push(y(y({},t),{},{modelCode:e.modelCode}))}))})),console.log(i,"filterTicketLists"),u=!1,i.length>0&&i[0].num<=0&&(u=!0),console.log(u,"over"),!u){r.next=21;break}return e.showToast({title:"年票已售罄",icon:"none"}),r.abrupt("return",u);case 21:return v.default.forEach(i,(function(r){if(console.log(i.length,r.num,"年票库存不足"),t.reserveData.length>r.num)return e.showToast({title:"年票库存不足",icon:"none"}),void(u=!0)})),r.abrupt("return",u);case 23:case"end":return r.stop()}}),r)})))()},getTextByDate:function(e){return this.$dayjs(e).format("YYYY-MM-DD")},hideBottom:function(){this.showBottom=!1},handleSubmitOrder:function(){var t=this;return(0,c.default)(o.default.mark((function r(){var a,n,s,c,i,u,l,d,f,h,m,k,y,D,T,C,b,P,w,x,I,O,S,L,E,N,_,M,$,B;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.disabledButton){r.next=2;break}return r.abrupt("return");case 2:e.showLoading({title:"加载中",mask:!0}),t.disabledButton=!0,a=t.buyer,n=a.id,s=a.openId,c=a.phoneNumber,i={};try{console.log(t.reserveData,"this.reserveData"),i=v.default.head(t.reserveData)}catch(e){console.log(e)}return console.log(i,"credential"),u={id:n,openId:s,mobile:c,credentialNo:i.certNo,credentialType:String(i.cardType),name:i.name},l=t.reserveData[0],d=l.itemId,f=l.modelCode,h=l.price,m=l.nickName,k=l.endTime,y=l.startTime,D=[],t.reserveData.forEach((function(e){var t=e.certNo,r=e.cardType,a=e.name,n=e.phone;D.push({certNo:t,certType:r,realName:a,telephone:n})})),T=[{amount:t.reserveData.length,fsName:"全天",needConfirm:"F",spiltEndTime:k,spiltStartTime:y,wayType:"6",price:h,modelCode:f,itemId:d,ticketName:m,orderCertAuthList:D}],C={buyer:u,startDate:t.selectDate,endDate:t.selectDate,saveOrders:T,wayType:"6"},console.log(C,"orderBody postData---下单参数-----"),r.next=17,(0,p.getTradDsaveOrder)(C);case 17:if(b=r.sent,P=b.data,w=b.success,x=b.message,console.log(C,P,"getTradDsaveOrder ==> 下单参数 ==> 下单结果"),!w){r.next=46;break}return I=P.paySum,O=P.payOrderNo,S=P.orderCode,t.orderCode=S,r.next=27,(0,p.getMerchantPayType)({payOrderNo:O});case 27:return L=r.sent,E=L.channelProductCode,N=L.payType,console.log(E,N,"getMerchantPayType"),r.next=33,(0,p.getOrderToPay)({payOrderNo:O,paySum:I,openId:s,channelProductCode:E,payType:N,extendParamJson:{openId:s,channelProductCode:E}});case 33:if(_=r.sent,console.log(_,"getOrderToPay"),!_.pay){r.next=39;break}return r.next=38,t.pluginMallrequestPayment(_).then((function(){e.showLoading({title:"加载中",mask:!0}),v.default.delay((function(r){console.log(r,_,"支付成功"),t.toOrderPageResult(),e.hideLoading()}),4e3,"支付成功后等待4s等待结果同步")})).catch((function(e){console.log(e),t.toOrderPageResult({type:2})}));case 38:return r.abrupt("return",!1);case 39:return e.showLoading({title:"加载中",mask:!0}),r.next=42,(0,p.getMiniProgramTemplate)();case 42:return M=r.sent,v.default.isEmpty(M)||(B=null===($=v.default.find(M,{templateType:"park-OrderPaySuccessEvent"}))||void 0===$?void 0:$.templateId,g.default.subscription([B])),v.default.delay((function(e){console.log(e,_,"零元支付成功"),t.toOrderPageResult()}),4e3,"不用拉起支付.等待4s等待支付同步"),r.abrupt("return");case 46:e.showToast({title:x,icon:"none"});case 47:case"end":return r.stop()}}),r)})))()},toOrderPageResult:function(t){(0,f.navigateTo)(f.PAGE_PATH.TICKETS_RESULT,y({orderCode:this.orderCode,source:"yearPack"},t),"reLaunch"),e.hideLoading()}})}}).call(this,r("bc2e").default,r("543d").default)},be2a:function(e,t,r){r.r(t);var a=r("65ba"),n=r.n(a);for(var o in a)["default"].indexOf(o)<0&&function(e){r.d(t,e,(function(){return a[e]}))}(o);t.default=n.a},c865:function(e,t,r){r.r(t);var a=r("dd12"),n=r("be2a");for(var o in n)["default"].indexOf(o)<0&&function(e){r.d(t,e,(function(){return n[e]}))}(o);r("7493");var s=r("f0c5"),c=Object(s.a)(n.default,a.b,a.c,!1,null,"aee6ecd0",null,!1,a.a,void 0);t.default=c.exports},d920:function(e,t,r){(function(e,t){var a=r("4ea4");r("6cdc"),a(r("66fd"));var n=a(r("c865"));e.__webpack_require_UNI_MP_PLUGIN__=r,t(n.default)}).call(this,r("bc2e").default,r("543d").createPage)},dd12:function(e,t,r){r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return o})),r.d(t,"a",(function(){return a}));var a={topBar:function(){return Promise.all([r.e("common/vendor"),r.e("pages/components/top-bar/index")]).then(r.bind(null,"6ebb"))},uniPopup:function(){return r.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(r.bind(null,"27c0"))}},n=function(){var e=this,t=(e.$createElement,e._self._c,e.__map(e.reserveData,(function(t,r){return{$orig:e.__get_orig(t),g0:t.showSave&&e.savePersons.length>0}}))),r=e.checkList.length;e.$mp.data=Object.assign({},{$root:{l0:t,g1:r}})},o=[]}},[["d920","common/runtime","common/vendor","pages/tickets/common/vendor"]]]);