require("../../common/vendor.js"),(global.webpackJsonp=global.webpackJsonp||[]).push([["pages/tickets/buytickets/selectroom/selectroom"],{"352b":function(e,t,r){r.d(t,"b",(function(){return n})),r.d(t,"c",(function(){return o})),r.d(t,"a",(function(){return a}));var a={topBar:function(){return Promise.all([r.e("common/vendor"),r.e("pages/components/top-bar/index")]).then(r.bind(null,"6ebb"))},uniPopup:function(){return r.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(r.bind(null,"27c0"))}},n=function(){var e=this,t=(e.$createElement,e._self._c,e.isBuy&&e.childTicket.maxNum>0?e.__map(e.addData,(function(t,r){return{$orig:e.__get_orig(t),g0:t.showSave&&e.savePersons.length>0}})):null),r=e.__map(e.users,(function(t,r){return{$orig:e.__get_orig(t),m0:t.modelName&&"year"===e.source&&"T"===e.showEntryType?e.size(t._selectTickets):null,m1:t.modelName&&"year"!==e.source?e.size(t.mallInner)>0||"3"===t.ticketType:null,m2:t.modelName&&"year"!==e.source?"3"===t.ticketType&&!t.selectTicketName&&0===e.size(t.mallInner):null,m3:t.modelName?e.size(t.mallShow):null}})),a=e.checkList.length;e._isMounted||(e.e0=function(t){e.isMore=!e.isMore}),e.$mp.data=Object.assign({},{$root:{l0:t,l1:r,g1:a}})},o=[]},"37f4":function(e,t,r){r.r(t);var a=r("b4e9"),n=r.n(a);for(var o in a)["default"].indexOf(o)<0&&function(e){r.d(t,e,(function(){return a[e]}))}(o);t.default=n.a},"6e8c":function(e,t,r){(function(e,t){var a=r("4ea4");r("6cdc"),a(r("66fd"));var n=a(r("98c3"));e.__webpack_require_UNI_MP_PLUGIN__=r,t(n.default)}).call(this,r("bc2e").default,r("543d").createPage)},"98c3":function(e,t,r){r.r(t);var a=r("352b"),n=r("37f4");for(var o in n)["default"].indexOf(o)<0&&function(e){r.d(t,e,(function(){return n[e]}))}(o);r("e9b4");var s=r("f0c5"),i=Object(s.a)(n.default,a.b,a.c,!1,null,"edd0cb26",null,!1,a.a,void 0);t.default=i.exports},b4e9:function(e,t,r){(function(e,a){var n=r("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=n(r("2eee")),s=n(r("448a")),i=n(r("c973")),c=n(r("9523")),l=r("fc36"),u=r("f1c8"),d=r("3a85"),f=r("b35a"),m=n(r("2ef0")),h=(r("b35a"),n(r("5d2d"))),p=r("26cb"),k=r("f2d7"),T=r("a887");function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach((function(t){(0,c.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var g="上午",y="10",N="11",b=!1,x="Um_Event_ChoosePageView",D=null,S=[],w=[],I=[],L=[],E=0,B="",P={},O=!0;t.default={components:{ticketBox:function(){Promise.all([r.e("pages/tickets/common/vendor"),r.e("pages/tickets/components/ticket-box/index")]).then(function(){return resolve(r("428e"))}.bind(null,r)).catch(r.oe)},submitOrder:function(){Promise.all([r.e("pages/tickets/common/vendor"),r.e("pages/tickets/components/submit-order/index")]).then(function(){return resolve(r("e573"))}.bind(null,r)).catch(r.oe)}},data:function(){return{COS_PATH:u.COS_PATH,height:"",size:m.default.size,isCheckall:!1,users:[],bookRemind:"",isBuy:!1,isCheckTicketType:!1,selectName:"",selectTicketName:"",selectTickets:[{name:"全价票",remark:"凭身份证入园",check:!1},{name:"优惠票",remark:"儿童、学生（7周岁(含)-18周岁(不含)",check:!1},{name:"免票",remark:"60周岁以上老人、残疾人、现役军人",check:!1}],userIndex:0,isBuyFreeList:[],popupTicketUser:"",isSelectUserlist:!1,chantParkTicketList:[],allTickets:[],saveOrders:[],freeList:[],orderInfo:{},totalPrice:0,options:{},source:"",selectData:"",selectSchedule:"",phone:"",passCertAuthList:[],orderDetail:{},needShowEntry:!1,showEntryType:"F",parentTicketList:[],pageMeta:{name:"选择两馆及展览页",category:"推荐",type:"填写页",column:"购票约展",plate:"信息填写"},eventName:"Um_Event_ChooseButtonClick",childTicket:{num:0,maxNum:0,ticketNickName:"未成年人免费票",price:0},addData:[],showBottom:!0,inputDisable:!1,showOftenUse:!1,currentPersonIndex:"",savePersons:[],isMore:!0,cardList:[],errorMessage:"",checkList:""}},computed:v({},(0,p.mapGetters)({reserve:"getReserveData"})),onLoad:function(e){var t=this;return(0,i.default)(o.default.mark((function r(){var a,n,s,i,c;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t.options=e,console.log(e,"******pages onload options*******"),t.reserve&&(t.selectSchedule=t.reserve.selectSchedule,t.selectData=t.reserve.selectData,t.passCertAuthList=t.reserve.passCertAuthList,t.phone=t.reserve.phone,t.source=t.reserve.source),console.log(t.reserve,"新下单数据"),!e.url||"result"!==e.url){r.next=24;break}return a=e.orderCode,n=void 0===a?"":a,s=[],i=[],r.next=10,(0,d.getMallOrderDetail)({orderCode:n});case 10:c=r.sent,m.default.forEach(c.visitors,(function(e,t){m.default.forEach(e.goodsList,(function(r){var a=r.goodsCode,n=r.goodsName,o=r.orderSum,c=r.goodsNickName,l=r.subType,u=r.isUsed,d=r.checkMobx,f=r.unableStatus;s.push({subType:l,isUsed:u,checkMobx:d,unableStatus:f,amount:1,userIndex:t,modelCode:a,price:o,ticketName:c,parentModelCode:e.mainTicketCode,visitorName:e.visitorName}),m.default.eq(a,e.mainTicketCode)&&i.push({ticket:n,subType:l,modelCode:e.mainTicketCode,name:e.visitorName,cardType:e.visitorCertType,certNo:e.visitorCertNo,checkCard:!0})}))})),t.source=9===c.goodsList[0].subType?"year":"normal",console.log(t.source,"this.source 加购"),t.reserve.selectSchedule=c.spiltName,t.selectSchedule=t.reserve.selectSchedule,t.reserve.selectData=c.visitDateFormat,t.passCertAuthList=i,t.orderDetail=c,t.isBuyFreeList=s,t.isBuy=!0,console.log(i,"已购用户信息"),console.log(c,"已购项目信息"),console.log(s,"已购票型");case 24:if("year"!==t.source){r.next=30;break}return r.next=27,t.getShowEntryType();case 27:t.showEntryType=r.sent,t.eventName="Um_Event_YearTicketChooseButtonClick",x="Um_Event_YearTicketChoosePageView";case 30:t.getData();case 31:case"end":return r.stop()}}),r)})))()},mounted:function(){this.setScrollHeight()},onShow:function(){D=new Date,console.log("onShow",D)},onHide:function(){var e=new Date-D;console.log("onHide",e,this.source,x),this.handleCommonUma(x,{Um_Key_Duration:e})},onUnload:function(){var e=new Date-D;this.handleCommonUma(x,{Um_Key_Duration:e})},methods:{setScrollHeight:function(){var t=this.systemInfo,r=t.statusBarHeight,a=t.system,n=/ios/i.test(a)?44:46;console.log(n,r,"statusBarHeight");var o=e.getSystemInfoSync().windowHeight-n-r-82;this.height=o,console.log(o,"获取子组件高度")},getShowEntryType:function(){return(0,i.default)(o.default.mark((function e(){var t;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,f.getSysParamByKey)({key:"gg_annual_is_add"});case 2:return t=e.sent,e.abrupt("return",null==t?void 0:t.message);case 4:case"end":return e.stop()}}),e)})))()},getData:function(){var t=this;return(0,i.default)(o.default.mark((function r(){var a,n,s,i,c,l,f,h,p,k,T,C,g,b,x,D,S,P;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(a=t.passCertAuthList,n=t.reserve.selectData,s={date:n},i=[],"year"!==t.source){r.next=14;break}return r.next=7,(0,d.getChantParkTicketList)(s);case 7:return c=r.sent,i=(i=c&&c.ticketList).filter((function(e){return"主题免费日"!==e.nickName})),s.merchantParkInfoId=u.YEAR_CARD_MERCHANT_PARK_ID,r.next=13,t.verifiyYearCard(a);case 13:a=r.sent;case 14:return r.next=16,(0,d.getChantParkTicketList)(s);case 16:return l=r.sent,f=l.ticketList,console.log(s,f,"门票查询数据/门票列表----"),console.log(f,"门票:ticketList"),console.log(i,"年票门票list"),"1",h=m.default.filter("year"===t.source?i:f,(function(e){return"1"===e.ticketType})),t.selectTickets=m.default.forEach(h,(function(e){e.check=!1})),t.chantParkTicketList="year"===t.source?i:f,f=f.concat(i),r.next=28,t.getMallTimeReserveListByTicket(f);case 28:return p=r.sent,console.log(p,"门票分时库存"),k=f.map((function(e){return e.modelCode})),r.next=33,(0,d.getMallAddTickets)({model:k,date:n});case 33:return T=r.sent,w=T,console.log(T,"addTickets"),r.next=38,t.addticketsTransful(T);case 38:if(C=r.sent,console.log(C,"加购票分时库存"),(g=C.map((function(e){return p.forEach((function(t){m.default.eq(e.modelCode,t.modelCode)&&(e=v(v({},e),t))})),e}))).forEach((function(e){e.ticketStatus=4;var t=m.default.groupBy(e.addTickets,"subType");e.mallInner=m.default.get(t,y)||[],e.mallShow=m.default.get(t,N)||[]})),a=a.map((function(e,r){m.default.cloneDeep(g).forEach((function(r){if(m.default.eq(e.modelCode,r.modelCode)){if(t.isBuy&&m.default.eq(t.source,"year")){m.default.forEach(t.isBuyFreeList,(function(t){m.default.eq(e.modelCode,t.parentModelCode)&&(r.isBuyTicket=!0)}));var a=m.default.groupBy(r.addTickets,"subType");r.mallInner=m.default.get(a,y)||[],r.mallShow=m.default.get(a,N)||[];var n=m.default.groupBy(t.isBuyFreeList,"subType"),o=m.default.get(n,N);console.log(o,"showMall");var s=r.mallShow,i=[];if(m.default.forEach(o,(function(e){e.unableStatus||i.push(e.modelCode)})),console.log(i,"checkedCode"),i&&m.default.size(i)===m.default.size(s))r.mallShow=[];else if(m.default.size(i)>0){var c=m.default.filter(s,(function(e){return-1===i.indexOf(e.modelCode)}));r.mallShow=c}}else{m.default.forEach(t.isBuyFreeList,(function(t){m.default.eq(e.modelCode,t.parentModelCode)&&m.default.eq(e.name,t.visitorName)&&(r.isBuyTicket=!0,r.addTickets=r.addTickets.filter((function(e){return m.default.eq(t.checkMobx.status,4)||e.modelCode!==t.modelCode})))}));var l=m.default.groupBy(r.addTickets,"subType");r.mallInner=m.default.get(l,y)||[],r.mallShow=m.default.get(l,N)||[]}var u=m.default.cloneDeep(r);e=v(v({},u),{},{username:e.name,userCertNo:e.certNo,userinfo:e})}}));var a=m.default.cloneDeep(t.selectTickets);return e._selectTickets=a,e})),t.users=a,t.allTickets=g,t.isBuy&&t.users.forEach((function(e){if(m.default.eq(e.ticketType,"3")){var r=t.orderDetail.visitors,a=m.default.find(r,{visitorName:e.username}).goodsList,n="",o=[];a.forEach((function(e){if(e.parentTicketCode){if(""==n){n=e.parentTicketCode;var r=m.default.filter(t.allTickets,{modelCode:n});o=m.default.head(r).mallInner}o=o.filter((function(t){return t.modelCode!==e.goodsCode}))}})),e.mallInner=o}})),t.isBuy&&m.default.eq(t.source,"year")&&(t.needShowEntry=t.orderDetail.needShowEntry,t.parentTicketList=t.orderDetail.parentTicketList,t.handleParentTicket(t.parentTicketList),t.handleYearSelectPupuserList(t.parentTicketList)),t.calculationOrder(),!t.isBuy){r.next=67;break}return t.getContactsList(),console.log(w,"allAddTickets"),b=w.filter((function(e){var t=m.default.find(e.addTickets,(function(e){return"1"===e.subType}));return e.flag=t,e.flag})),I=m.default.map(b,"modelCode"),x=m.default.head(b).addTickets,L=m.default.filter(x,(function(e){return"1"===e.subType}))[0],r.next=57,(0,d.getQueryExchangeInfo)({parentOrderCode:t.orderDetail.orderCode,modelCode:L.modelCode});case 57:D=r.sent,console.log(D,"exchangeInfo"),t.childTicket=v(v({},L),{},{maxNum:D.leftTimes,num:0}),console.log(w,L,I,"allTickets"),S=t.users,console.log(S,"当前购买人"),E=m.default.findIndex(S,(function(e){return m.default.includes(I,e.modelCode)})),console.log(E,"默认加购主票"),P=t.users[E],B=P.modelCode;case 67:e.hideLoading({noConflict:!0});case 68:case"end":return r.stop()}}),r)})))()},addticketsTransful:function(){var e=arguments,t=this;return(0,i.default)(o.default.mark((function r(){var a,n;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=e.length>0&&void 0!==e[0]?e[0]:[],n=m.default.flatMap(m.default.map(a,(function(e){return e.addTickets}))),r.next=4,t.getMallTimeReserveListByTicket(n);case 4:return r.abrupt("return",a);case 5:case"end":return r.stop()}}),r)})))()},getMallTimeReserveListByTicket:function(){var e=arguments,t=this;return(0,i.default)(o.default.mark((function r(){var a,n,s,i,c,l,u;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=e.length>0&&void 0!==e[0]?e[0]:[],n=t.reserve,s=n.selectData,i=n.selectSchedule,c=[],m.default.forEach(a,(function(e){c.push({modelCode:e.modelCode,externalCode:e.externalCode,startTime:s,endTime:s})})),r.next=6,(0,d.getMallBatchTimeReserveList)({queryParam:c});case 6:return l=r.sent,u=m.default.assignWith(a,l,(function(e,t){e.morning={},e.afternoon={};var r=t.fsList;if(m.default.isArray(r)){var a=m.default.size(r);m.default.eq(a,1)&&(e.morning=r[0],e.afternoon=r[0]),m.default.eq(a,2)&&(e.morning=r[0],e.afternoon=r[1])}var n=1,o="可订",s=e.morning,c=e.afternoon,l=e.salePriceStatus;switch(i){case g:m.default.eq(s.num,0)&&(n=2,o="约满");case"下午":m.default.eq(s.num,0)&&(n=2,o="约满"),m.default.eq(c.num,0)&&(n=2,o="约满");default:m.default.eq(l,"F")&&(n=2,o="暂闭")}return e.ticketStatus=n,e.ticketStatusName=o,e})),r.abrupt("return",u);case 9:case"end":return r.stop()}}),r)})))()},verifiyYearCard:function(e){var t=this,r=[];return new Promise(function(){var a=(0,i.default)(o.default.mark((function a(n,s){var i,c,l,u,f,h,p;return o.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:i=0;case 1:if(!(i<e.length)){a.next=12;break}return c=e[i],a.next=5,(0,d.getVerifiyYearCard)({certNo:c.certNo,certType:c.certType,tradeDate:t.selectData});case 5:l=a.sent,u=l.totalNum,f=l.canUseNum,h=l.tel,p=m.default.subtract(u,f),r.push(v(v(v({},c),l),{},{usedNum:p,tel:h}));case 9:i++,a.next=1;break;case 12:n(r);case 13:case"end":return a.stop()}}),a)})));return function(e,t){return a.apply(this,arguments)}}())},handleOpenBuytips:function(e){this.handleCommonUma(this.eventName,{Um_Key_ButtonName:"购买须知"}),this.bookRemind=e.bookRemind,this.$refs.popupBuy.open("bottom")},handleCloseBuytips:function(){this.$refs.popupBuy.close()},handleOpenUser:function(e){this.handleCommonUma(this.eventName,{Um_Key_ButtonName:"选择票价类型"}),console.log(e),this.selectName=e.userinfo.name,this.selectTicketName=e.selectTicketName||"请选择",this.$refs.popupUser.open("bottom")},handleParentTicket:function(e){var t=this;e.forEach((function(e){if(e.parentTicketCode){var r,a=m.default.filter(t.allTickets,{modelCode:e.parentTicketCode})[0].mallInner;console.log(t.isBuyFreeList,a);var n=m.default.groupBy(t.isBuyFreeList,"visitorName");r=a.filter((function(t){return!n[e.name].find((function(e){return e.modelCode===t.modelCode}))})),m.default.forEach(t.users,(function(t){t.username===e.name&&(t.isSelectUserlist=!0,t.mallInner=(0,s.default)(m.default.cloneDeep(r)))}))}}))},handleSelectPupuserList:function(e){var t=this,r=[];m.default.forEach(this.users,(function(a){var n=m.default.filter(e,{name:a.username});if(n&&m.default.size(n)>0){var o=m.default.find(n,(function(e){return""!==e.parentTicketCode}));if(o){var s=o.parentTicketCode,i=m.default.filter(t.allTickets,{modelCode:s})[0].nickName;r.push(v(v({},a),{},{selectName:a.username,ticketName:i,cantChange:!0}))}else r.push(v(v({},a),{},{selectName:a.username,ticketName:"请选择"}))}})),this.selectPupuserList=r},handleSelectTicket:function(e){var t=this;return(0,i.default)(o.default.mark((function r(){var a,n,i,c,l,u,d;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return t.selectTickets.forEach((function(e){e.check=!1})),t.selectTickets[e].check=!0,a=t.selectTickets[e].nickName,n=m.default.filter(t.chantParkTicketList,{nickName:a}),i=n[0].modelCode,c=m.default.filter(t.allTickets,{modelCode:n[0].modelCode}),l=c[0].mallInner,m.default.forEach(l,(function(e){e.parentTicketCode=i})),u=m.default.head(m.default.filter(t.users,{username:t.selectName})),r.next=11,t.getTicketVerification(u,c[0]);case 11:d=r.sent,console.log(d,"用户信息校验"),d&&(t.selectTicketName=a,u.selectTicketName=a,u.mallInner=(0,s.default)(m.default.cloneDeep(c[0].mallInner)),t.isCheckTicketType=!0,t.$refs.popupTicket.close());case 14:case"end":return r.stop()}}),r)})))()},handleYearSelectPupuserList:function(e){var t=this;m.default.forEach(this.users,(function(r){var a=m.default.filter(e,{name:r.username});if(a&&m.default.size(a)>0){var n=m.default.find(a,(function(e){return""!==e.parentTicketCode}));if(n){var o=n.parentTicketCode,i=m.default.filter(t.allTickets,{modelCode:o})[0],c=i.nickName,l=i.modelCode,u=i.mallInner;r.cantChange=!0,m.default.forEach(u,(function(e){e.parentTicketCode=l}));var d=[];if(t.isBuy){var f=m.default.groupBy(t.isBuyFreeList,"visitorName");d=u.filter((function(e){return!f[r.username].find((function(t){return t.modelCode===e.modelCode}))}))}else d=u;r.mallInner=(0,s.default)(m.default.cloneDeep(d)),r._selectTickets.forEach((function(e){e.nickName===c&&(e.check=!0,r.isSelectTicketType=!0)}))}}}))},handleYearSelectTicket:function(t,r){var a=this;return(0,i.default)(o.default.mark((function n(){var i,c,l,u,d;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(console.log(a.eventName,"年票登记确定票型"),a.handleCommonUma(a.eventName,{Um_Key_ButtonName:"年票登记确定票型"}),!t.cantChange){n.next=5;break}return e.showToast({title:"加购不可更改票型",icon:"none",duration:2e3,mask:!0}),n.abrupt("return");case 5:if(!r.check){n.next=11;break}return r.check=!1,t.mallInner=[],t.isSelectTicketType=!1,a.calculationOrder("year"),n.abrupt("return");case 11:return t._selectTickets.forEach((function(e){e.check=!1})),r.nickName,i=r.modelCode,c=m.default.filter(a.allTickets,{modelCode:i}),l=c[0].mallInner,m.default.forEach(l,(function(e){e.parentTicketCode=i})),u=[],a.isBuy?(d=m.default.groupBy(a.isBuyFreeList,"visitorName"),u=l.filter((function(e){return!d[t.username].find((function(t){return t.modelCode===e.modelCode}))}))):u=l,n.next=22,a.getTicketVerification(t,r);case 22:n.sent?(t.mallInner=(0,s.default)(m.default.cloneDeep(u)),r.check=!0,t.isSelectTicketType=!0):(t.mallInner=[],t.isSelectTicketType=!1,r.check=!1),a.calculationOrder("year");case 25:case"end":return n.stop()}}),n)})))()},getTicketVerification:function(e,t){var r=this;return(0,i.default)(o.default.mark((function n(){var s,i,c,l,u,f;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=r.reserve.selectData,console.log(e,e.userinfo,t),i={cardType:e.userinfo.cardType,certNo:e.userinfo.certNo,name:e.userinfo.name},c={modelCode:t.modelCode,parentModelCode:t.modelCode},l=[{certAuthDTOS:[i],modelCodesDTOS:[c]}],n.next=7,(0,d.getTicketVerification)({ticketVerificationDTOS:l,startDate:s,chooseRuleProcessors:"AgeRangeRuleCheck"});case 7:if(u=n.sent,m.default.isEmpty(u.passCertAuthList)){n.next=12;break}return n.abrupt("return",!0);case 12:return f=u.rejectCertAuthList[0].resultMsg,a.showToast({title:f,icon:"none"}),n.abrupt("return",!1);case 15:console.log(u,"用户信息校验");case 16:case"end":return n.stop()}}),n)})))()},handleCloseUser:function(){this.$refs.popupUser.close()},handleOpenTicket:function(e,t){var r=this;e.cantChange||(console.log(e,t),e.selectName?(this.userIndex=t,this.popupTicketUser=e.selectName,m.default.forEach(this.selectTickets,(function(t){t.check=!1,t.nickName===e.ticketName&&(t.check=!0)})),this.$refs.popupTicketUserlist.open("bottom")):(console.log(this.selectTickets),m.default.forEach(this.selectTickets,(function(e){e.check=!1,e.nickName===r.selectTicketName&&(e.check=!0)})),this.$refs.popupTicket.open("bottom")))},handleCloseTicket:function(){this.$refs.popupTicket.close(),this.$refs.popupTicketUserlist.close()},handleCheckall:function(){var e=this;this.isCheckall=!this.isCheckall,this.users.forEach((function(t){t.mallInner.forEach((function(t){2!==t.ticketStatus&&4!==t.ticketStatus&&(e.isCheckall?t.ticketStatus=3:t.ticketStatus=1)})),t.mallShow.forEach((function(t){2!==t.ticketStatus&&4!==t.ticketStatus&&(e.isCheckall?t.ticketStatus=3:t.ticketStatus=1)}))})),this.calculationOrder()},handleCheckTicket:function(e,t,r){console.log(e,t,r);var a=m.default.cloneDeep(this.users),n=null;"两馆"===r&&(n=a[e].mallInner[t]),"展览"===r&&(n=a[e].mallShow[t]),console.log(n.ticketNickName,this.eventName,"子馆展览"),this.handleCommonUma(this.eventName,{Um_Key_ButtonName:n.ticketNickName}),console.log(n,"handleCheckTicket item"),1===n.ticketStatus?n.ticketStatus=3:3===n.ticketStatus&&(n.ticketStatus=1),this.users=a,this.calculationOrder()},calculationOrder:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";"year"===t&&(this.saveOrders=[],this.orderInfo={users:[]},this.totalPrice=0);var r=m.default.filter(this.freeList,(function(t){return console.log(t.modelCode,e.childTicket.modelCode,"保留"),t.modelCode==e.childTicket.modelCode}));console.log(r,"freeList");var a=[],n=this.reserve.selectSchedule,o=m.default.eq(n,g),s={users:[]},i=[],c=0,l=m.default.groupBy(this.users,"modelCode");console.log(l,"用户所有主票型划分"),Object.keys(l).forEach((function(e){var t=l[e],a=m.default.nth(t,0);a.isBuyTicket||(r.push({ticketName:a.nickName,modelCode:a.modelCode,price:a.price,amount:m.default.size(t),ticketType:a.ticketType}),t.forEach((function(e){c+=e.price})))})),console.log(c,"主票价格"),this.users.forEach((function(t,r){console.log(t,r,"this.users.forEach item");var i=t.modelName,l=t.price,u=t.modelCode,d=t.itemId,f=t.morning,h=t.afternoon,p=t.userinfo;t.children=[];var k={name:p.name,ticketName:p.ticketName,totalPrice:t.price,freeList:[],tickets:[]};t.isBuyTicket||k.freeList.push({ticketName:t.nickName,price:t.price,modelCode:t.modelCode,amount:1,ticketType:t.ticketType});var T={realName:p.name,certNo:p.certNo,certType:p.cardType,ticketName:p.ticketName,checkCard:p.checkCard};["mallInner","mallShow"].forEach((function(r){t[r].forEach((function(r){r.parentModelCode=t.modelCode,r.passCertAuth=T,r.parentUsername=T.realName,r.certNo=T.certNo,r.parentTimeReserve={morning:t.morning,afternoon:t.afternoon};var s={ticketName:i,price:l,amount:1,modelCode:u,itemId:d,wayType:"6",fsName:n,orderCertAuthList:[T],needConfirm:"F"};if(e.isBuy){var p=e.orderDetail,C=p.spiltStartTime,v=p.spiltEndTime;s.spiltStartTime=C,s.spiltEndTime=v}else s.spiltStartTime=o?f.startTime:h.startTime,s.spiltEndTime=o?f.endTime:h.endTime;r.parentInfo=s,m.default.eq(r.ticketStatus,3)&&(k.tickets.push(r),a.push(r),t.children.push(r),c+=Number(r.price))}))})),k.tickets.forEach((function(e){k.totalPrice+=Number(e.price)})),k.totalPrice=m.default.round(k.totalPrice,2);var C=m.default.groupBy(k.tickets,"modelCode");Object.keys(C).forEach((function(e){var t=C[e],r=m.default.nth(t,0);k.freeList.push({ticketName:r.ticketNickName,price:r.price,amount:m.default.size(t),modelCode:r.modelCode,subType:r.subType})})),s.users.push(k)})),c=m.default.round(c,2);var u=m.default.groupBy(a,"modelCode");console.log(u,a,"用户所选加票型划分"),Object.keys(u).forEach((function(e){var t=u[e],a=m.default.nth(t,0);r.push({ticketName:a.ticketNickName,price:a.price,amount:m.default.size(t),modelCode:a.modelCode,parentModelCode:a.parentModelCode,subType:a.subType})}));var d=m.default.groupBy(a,"parentModelCode");console.log(d,"用户所选加票根据主票型划分"),Object.keys(d).forEach((function(e){var t=d[e],r=m.default.groupBy(t,"certNo"),a=v(v({},t.parentInfo),{},{amount:0,orderCertAuthList:[]});Object.keys(r).forEach((function(e){var t=r[e],n=m.default.nth(t,0);a.orderCertAuthList.push(n.passCertAuth),a.amount+=1})),i.push(a)})),i=[];var f=m.default.groupBy(this.users,"modelCode");Object.keys(f).forEach((function(t){var r=f[t],a=m.default.nth(r,0),s=m.default.groupBy(r,"userCertNo"),c=a.modelName,l=a.modelCode,u={ticketName:c,price:a.price,amount:0,modelCode:l,itemId:a.itemId,wayType:"6",fsName:n,orderCertAuthList:[],needConfirm:"F"};if(e.isBuy){var d=e.orderDetail,h=d.spiltStartTime,p=d.spiltEndTime;u.spiltStartTime=h,u.spiltEndTime=p}else{var k=a.morning,T=a.afternoon;u.spiltStartTime=o?k.startTime:T.startTime,u.spiltEndTime=o?k.endTime:T.endTime}Object.keys(s).forEach((function(e){var t=s[e],r=m.default.nth(t,0).userinfo,a={realName:r.name,ticket:r.ticket,certType:r.cardType,certNo:r.certNo,checkCard:r.checkCard,telephone:r.tel};u.amount+=1,u.orderCertAuthList.push(a)})),i.push(u)})),console.log(r,"freeList"),console.log(i,"saveOrders"),console.log(c,"totalPrice"),console.log(s,"orderInfo"),console.log(this.users,"*********this.users-data********"),this.saveOrders=i,this.freeList=r,this.orderInfo=s,this.totalPrice=c},handleSubmitOrder:function(){var e=this;return(0,i.default)(o.default.mark((function t(){var r,n,s,i,c,u,d;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=e.addData,n=e.freeList,!(r.length>0)){t.next=15;break}return t.next=4,e.handleCheckAllIn();case 4:if(e.allIn){t.next=6;break}return t.abrupt("return",a.showToast({title:"请填写正确的未成年人信息",icon:"none"}));case 6:return t.next=8,e.checkTicket();case 8:if(t.sent){t.next=11;break}return t.abrupt("return");case 11:return t.next=13,e.handleChildTicketData();case 13:t.next=17;break;case 15:if(!(n.length<=0)){t.next=17;break}return t.abrupt("return",a.showToast({title:"请选择门票",icon:"none"}));case 17:s=e.orderInfo,i=e.totalPrice,c=e.saveOrders,console.log(n,s,i,c,"提交订单"),u=Number(e.isBuy),d=e.orderDetail.orderCode,h.default.set("freeList",e.freeList),console.log(s,"orderInfo----orderInfo-----"),console.log(i,"totalPrice----totalPrice-----"),console.log(c,"saveOrders----saveOrders-----"),console.log(n,"freeList----freeList-----"),(0,l.navigateTo)(l.PAGE_PATH.TICKETS_CONFIRM_ORDER,{saveOrders:encodeURIComponent(JSON.stringify(c)),freeList:encodeURIComponent(JSON.stringify(n)),orderInfo:encodeURIComponent(JSON.stringify(s)),totalPrice:i,isAddBuy:u,parentOrderCode:d});case 27:case"end":return t.stop()}}),t)})))()},handleChildTicketData:function(){var e=this;return(0,i.default)(o.default.mark((function t(){var r,a,n,s,i,c,l,u,f,h,p,k,T,C,g,y,N,b,x,D,S,w;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.reserve,a=r.selectData,n=r.selectSchedule,s=e.childTicket,i=e.addData,c=e.users[E],l=c.modelName,u=c.price,f=c.modelCode,h=c.itemId,p=[{modelCode:s.modelCode,externalCode:s.externalCode,startTime:a,endTime:a}],t.next=7,(0,d.getMallBatchTimeReserveList)({queryParam:p});case 7:k=t.sent,console.log(k,"timeReserveList"),T={realName:c.userinfo.name,certNo:c.userinfo.certNo,certType:c.userinfo.cardType,ticketName:c.ticket,checkCard:!0},C=[],i.forEach((function(e){var t={};t.realName=e.name,t.certNo=e.idCard,t.certType=e.selectCardType.id,t.checkCard=!0,C.push(t)})),console.log(C,"addCertAuthList"),(g={}).amount=i.length,g.parentModelCode=f,g.passCertAuth=C,g.parentUsername=T.realName,g.certNo=T.certNo,g.parentTimeReserve={morning:c.morning,afternoon:c.afternoon},y={ticketName:l,price:u,amount:1,modelCode:f,itemId:h,wayType:"6",fsName:n,orderCertAuthList:[T],needConfirm:"F"},N=e.orderDetail,b=N.spiltStartTime,x=N.spiltEndTime,y.spiltStartTime=b,y.spiltEndTime=x,g.parentInfo=y,D=k[0].fsList,m.default.isArray(D)&&(S=m.default.size(D),m.default.eq(S,1)&&(g.morning=D[0],g.afternoon=D[0]),m.default.eq(S,2)&&(g.morning=D[0],g.afternoon=D[1])),w=v(v({},g),s),console.log(w,"ticket"),console.log(e.orderInfo.users,"this.orderInfo.users"),m.default.remove(e.orderInfo.users[E].tickets,(function(e){return e.modelCode===s.modelCode})),m.default.remove(e.orderInfo.users[E].freeList,(function(e){return e.modelCode===s.modelCode})),console.log(e.orderInfo.users[E].tickets,"childTickets"),e.orderInfo.users[E].tickets.push(w),e.orderInfo.users[E].freeList.push(P);case 35:case"end":return t.stop()}}),t)})))()},addTicketsNum:function(){this.handleCommonUma(this.eventName,{Um_Key_ButtonName:"添加未成年人门票数量"});var e=this.childTicket,t=e.maxNum,r=e.num;console.log(r,"num"),r>=t||(this.addData.push({selectCardType:{id:0,name:"身份证"}}),this.$set(this.childTicket,"num",r+1),console.log(r,"num"),this.updateFreeList())},updateFreeList:function(){var e=this.childTicket,t=this.addData;P={amount:t.length,parentModelCode:B,price:0,modelCode:e.modelCode,subType:"1",ticketName:e.ticketNickName},m.default.remove(this.freeList,(function(t){return t.modelCode===e.modelCode})),m.default.remove(this.orderInfo.users[E].freeList,(function(t){return t.modelCode===e.modelCode})),console.log(this.freeList,this.childTicket,"this.freeList"),t.length>0&&this.freeList.push(P)},delTicketsNum:function(){this.handleCommonUma(this.eventName,{Um_Key_ButtonName:"减少未成年人门票数量"});var e=this.childTicket,t=(e.maxNum,e.num);t<=0||(this.addData.pop(),this.$set(this.childTicket,"num",t-1),this.updateFreeList())},selectCardlist:function(e){this.showBottom=!1,this.inputDisable=!0;var t=["id","pass"];console.log(t,"cardType");var r=[];m.default.forEach(t,(function(e){var t=m.default.find(u.ID_TYPE,{type:e.toUpperCase()});null!=t&&t&&r.push(t)})),console.log(r,"cardList"),this.cardList=r,this.$refs.popupCard.open("bottom"),this.currentPersonIndex=e},onSelectCard:function(e){this.showBottom=!0,this.addData[this.currentPersonIndex].selectCardType=e,this.$refs.popupCard.close(),this.inputDisable=!1,this.handleCheckAllIn("card",this.addData[this.currentPersonIndex],this.currentPersonIndex)},closeTypePop:function(){this.showBottom=!0,this.$refs.popupCard.close(),this.inputDisable=!1},handleCheckAllIn:function(e,t,r){var a=this;return(0,i.default)(o.default.mark((function n(){var s,i,c,l,u,d,f,h;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a.showBottom=!0,console.log("handleCheckAllIn",e,t),s=!0,i=a.addData,console.log(i," 选择之后的addData"),"card"!==e){n.next=14;break}return n.next=8,a.checkCardInput(t.selectCardType.id,t.idCard,r);case 8:c=n.sent,(l=t.idCard)&&m.default.endsWith(l,"x")&&(console.log("身份证X转大写"),t.idCard=(0,k.xToUpperCase)(t.idCard)),c||(s=!1),n.next=15;break;case 14:"name"===e&&(setTimeout((function(){a.hideSavePersons(r)}),100),console.log(b,"clickUserFlag"),b?b=!1:(u=a.checkNameInput(t,r),console.log(u,t,"checkName"),u||(s=!1)));case 15:if(!s){n.next=38;break}console.log("校验全局"),d=0;case 18:if(!(d<i.length)){n.next=38;break}if(i[d].name&&i[d].idCard){n.next=24;break}return s=!1,n.abrupt("continue",35);case 24:return console.log("是否都校验通过"),n.next=27,a.checkCardInput(i[d].selectCardType.id,i[d].idCard,d);case 27:if(f=n.sent,h=a.checkNameInput(i[d].name,d),f){n.next=32;break}return s=!1,n.abrupt("continue",35);case 32:if(h){n.next=35;break}return s=!1,n.abrupt("continue",35);case 35:d++,n.next=18;break;case 38:a.allIn=s,console.log(a.allIn,"allIn");case 40:case"end":return n.stop()}}),n)})))()},checkCardInput:function(e,t,r){var a=this;return(0,i.default)(o.default.mark((function n(){var s,i;return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log(e,"cardType","证件类型id"),s=!0,0===e?(s=(0,k.checkIdcard)(t))?(i=m.default.filter(a.addData,(function(e){return e.idCard===t})),console.log(i,"cards"),i.length>1?(a.$set(a.addData[r],"errorText","存在重复输入的证件号"),s=!1):(s=a.analyzeIDCard(t),a.$set(a.addData[r],"errorText","非未成年观众，请选择正确的门票类型"))):a.$set(a.addData[r],"errorText","请输入正确的证件号码"):void 0!==t&&""!==t.trim()||(s=!1,a.$set(a.addData[r],"errorText","请输入正确的证件号码")),console.log(s,"check"),a.$set(a.addData[r],"cardError",!s),console.log(s,"check年票校验"),n.abrupt("return",s);case 7:case"end":return n.stop()}}),n)})))()},checkNameInput:function(e,t){var r=!0;return console.log(e,"name"),void 0===e||""===e.trim()?(this.$set(this.addData[t],"nameError",!0),r=!1):this.$set(this.addData[t],"nameError",!1),r},selectSaveUser:function(e,t,r){var a=this;return(0,i.default)(o.default.mark((function n(){return o.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:b=!0,console.log(r,"item","选择常用游客信息"),console.log(t,"index","选择常用游客信息"),a.$set(a.addData[e],"idCard",r.idCard),a.$set(a.addData[e],"selectCardType",r.cardType),a.$set(a.addData[e],"showSave",!1),a.$set(a.addData[e],"cardError",!1),a.$set(a.addData[e],"nameError",!1),a.$set(a.addData[e],"userName",r.name),a.checkCardInput(r.cardType.id,r.idCard,e);case 10:case"end":return n.stop()}}),n)})))()},checkName:function(e){if(b){var t=this.addData[e].userName;this.$set(this.addData[e],"name",t)}this.handleCheckAllIn("name",this.addData[e].name,e)},hideSavePersons:function(e){this.$set(this.addData[e],"showSave",!1),this.showOftenUse=!1},getContactsList:function(){var e=this;return(0,i.default)(o.default.mark((function t(){var r;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,(0,T.getMallContactsList)();case 2:200==(r=t.sent).code&&(r=r.data),console.log(r,"list"),m.default.forEach(r,(function(e,t){console.log(e,"value");var r=m.default.find(u.ID_TYPE,{id:e.type});e.cardType=r})),console.log(r,"list"),e.savePersons=r,S=r;case 9:case"end":return t.stop()}}),t)})))()},showSavePersons:function(e){this.showBottom=!1;var t=this.addData,r=S.filter((function(e){return t.every((function(t){return t.idCard!=e.idCard}))}));m.default.size(r)>0&&(this.showOftenUse=!0,console.log(e,"index"),this.savePersons=r,this.$set(this.addData[e],"showSave",!0))},analyzeIDCard:function(t){var r=t.substring(6,10),a=t.substring(10,12),n=t.substring(12,14);console.log(r,a,n,"出生年月日");var o=e.getStorageSync("currTimeStamp"),s=this.$dayjs(1e3*o),i=s.format("YYYY"),c=s.format("MM"),l=s.format("DD");console.log(i,c,l,"当前年月日");var u=i-r;return(c<a||c==a&&l<n)&&u--,!(u>=18)},checkTicket:function(){var e=this;return(0,i.default)(o.default.mark((function t(){var r,a,n,s,i,c;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(O){t.next=2;break}return t.abrupt("return",!1);case 2:return console.log("checkTicket"),O=!1,r=e.users[E],console.log(r,"addChildUser"),a=e.reserve.selectData,n=[],m.default.forEach(e.addData,(function(e){var t={};t.name=e.name,t.certNo=e.idCard,t.cardType=e.selectCardType.id,n.push(t)})),s={modelCode:e.childTicket.modelCode,parentModelCode:e.childTicket.modelCode},r.userinfo.name,r.userinfo.certNo,r.userinfo.cardType,r.modelCode,r.modelCode,i=[{certAuthDTOS:n,modelCodesDTOS:[s]}],t.next=15,(0,d.getTicketVerification)({ticketVerificationDTOS:i,startDate:a,chooseRuleProcessors:""});case 15:if("string"==typeof(c=t.sent)){t.next=21;break}return O=!0,t.abrupt("return",!0);case 21:e.errorMessage=c;case 22:return e.showBottom=!1,e.inputDisable=!0,e.$refs.popupCheck.open("bottom"),console.log(c,"checkTicket result"),O=!0,t.abrupt("return",!1);case 28:case"end":return t.stop()}}),t)})))()},closeCheckModel:function(){this.showBottom=!0,this.$refs.popupCheck.close(),this.inputDisable=!1}}}}).call(this,r("bc2e").default,r("543d").default)}},[["6e8c","common/runtime","common/vendor","pages/tickets/common/vendor"]]]);