require("../../common/vendor.js"),(global.webpackJsonp=global.webpackJsonp||[]).push([["pages/tickets/buytickets/order/order"],{"10ed":function(e,t,n){n.r(t);var o=n("17b4"),r=n("83dc");for(var a in r)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(a);n("6b4a");var s=n("f0c5"),c=Object(s.a)(r.default,o.b,o.c,!1,null,"5f6d1236",null,!1,o.a,void 0);t.default=c.exports},"17b4":function(e,t,n){n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){return o}));var o={topBar:function(){return Promise.all([n.e("common/vendor"),n.e("pages/components/top-bar/index")]).then(n.bind(null,"6ebb"))}},r=function(){this.$createElement;this._self._c},a=[]},7874:function(e,t,n){(function(e){var o=n("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(n("2eee")),a=o(n("c973")),s=o(n("9523")),c=n("3a85"),i=n("4dcf"),d=n("b35a"),l=n("fc36"),u=o(n("2ef0")),f=n("26cb"),p=o(n("294b"));function m(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?m(Object(n),!0).forEach((function(t){(0,s.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}d.getModalContentByCodeId;var g="Um_Event_ConfirmOrderPageView",v=null;t.default={components:{submitOrder:function(){Promise.all([n.e("pages/tickets/common/vendor"),n.e("pages/tickets/components/submit-order/index")]).then(function(){return resolve(n("e573"))}.bind(null,n)).catch(n.oe)},KefuBar:function(){Promise.all([n.e("common/vendor"),n.e("pages/tickets/common/vendor"),n.e("pages/tickets/components/kefu-bar/index")]).then(function(){return resolve(n("fe65"))}.bind(null,n)).catch(n.oe)},ticketCheckModal:function(){Promise.all([n.e("pages/tickets/common/vendor"),n.e("pages/tickets/components/ticket-check-modal/index")]).then(function(){return resolve(n("4f70"))}.bind(null,n)).catch(n.oe)}},data:function(){return{height:"",freeList:[],saveOrders:[],orderInfo:{},addTickets:[],totalPrice:0,selectData:"",selectSchedule:"上午",phone:"",source:"",offlineList:[],userInfo:{},orderCode:"",check_in:{},annual_refund_rules:{},invoices:{},isAddBuy:!1,disabledButton:!1,pageMeta:{name:"确认订单页",category:"推荐",type:"详情页",column:"购票约展",plate:"订单"},eventName:"Um_Event_ConfirmOrderButtonClick",parentOrderCode:"",noticeData:{title:"购票提醒",content:""}}},computed:h({},(0,f.mapGetters)({reserveData:"getReserveData",buyer:"getMallBuyerData"})),onLoad:function(e){var t=this;return(0,a.default)(r.default.mark((function n(){var o,a,s,c,l,f,p,m,v,y,b,k;return r.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log(e,"******pages onload options*******"),t.isAddBuy=Number(e.isAddBuy),console.log(t.reserveData,"订单信息",t.isAddBuy,"this.isAddBuy"),t.disabledButton=!1,t.reserveData&&(t.offlineList=t.reserveData.list||[],t.selectSchedule=t.reserveData.selectSchedule||"下午",t.selectData=t.reserveData.selectData||t.$dayjs(new Date).format("YYYY-MM-DD"),t.phone=t.reserveData.phone||t.buyer.phoneNumber,t.source=t.reserveData.source||"",t.type=t.reserveData.type||""),"year"===t.source&&(t.eventName="Um_Event_YearTicketConfOrderButtonClick",g="Um_Event_YearTicketConfOrderPageView"),o=e.freeList,a=void 0===o?"":o,s=e.saveOrders,c=void 0===s?"":s,l=e.orderInfo,f=void 0===l?"":l,p=e.totalPrice,m=void 0===p?0:p,"offline"===t.type?t.offlineDataTransful():(t.freeList=JSON.parse(decodeURIComponent(a)),t.saveOrders=JSON.parse(decodeURIComponent(c)),v=JSON.parse(decodeURIComponent(f)),t.totalPrice=m,y=[],b=[],v.users.forEach((function(e){e.tickets.length>0&&(y=y.concat(e.tickets));var t=0;u.default.forEach(e.freeList,(function(e){t+=e.price})),e.showPrice=(0,i.keepTwoDecimalFull)(t)})),console.log(y,"allTickets"),k=u.default.groupBy(y,"parentModelCode"),console.log(k,"freeListByParentModelCode"),Object.keys(k).forEach((function(e){var n=u.default.groupBy(k[e],"modelCode");console.log(n,"freeListByModelcode"),Object.keys(n).forEach((function(e){var o=u.default.map(n[e],(function(e){return e.passCertAuth}));b.push({modelCode:n[e][0].modelCode,amount:"1"===n[e][0].subType?n[e][0].amount:n[e].length,parentModelCode:n[e][0].parentModelCode,parentTicketCode:n[e][0].parentTicketCode,spiltStartTime:"上午"===t.selectSchedule?n[e][0].morning.startTime:n[e][0].afternoon.startTime,spiltEndTime:"上午"===t.selectSchedule?n[e][0].morning.endTime:n[e][0].afternoon.endTime,fsName:t.selectSchedule,realName:"T",needConfirm:"F",orderCertAuthList:"1"===n[e][0].subType?n[e][0].passCertAuth:o})}))})),t.addTickets=b,t.orderInfo=v,u.default.eq(t.isAddBuy,1)&&(t.parentOrderCode=e.parentOrderCode)),t.userInfo=h(h({},t.buyer),{},{mobile:t.phone,name:t.buyer.nickName}),console.log(t.freeList,"freeList: 主票票种信息"),console.log(t.saveOrders,"saveOrders: 下单主票列表"),console.log(t.orderInfo,"orderInfo 各人员票型信息"),console.log(t.addTickets,"addTickets 下单加票列表"),console.log(t.offlineList,"offlineList"),console.log(t.buyer),n.next=17,(0,d.getModalContentByCodeId)({advertCode:"invoices"});case 17:return t.invoices=n.sent,n.next=20,(0,d.getModalContentByCodeId)({advertCode:"check_in"});case 20:return t.check_in=n.sent,n.next=23,(0,d.getModalContentByCodeId)({advertCode:"annual_refund_rules"});case 23:return t.annual_refund_rules=n.sent,console.log("annual_refund_rules",t.annual_refund_rules),n.next=27,t.pluginMallContactsInfo();case 27:case"end":return n.stop()}}),n)})))()},onShow:function(){v=new Date,console.log("onShow",v)},onHide:function(){var e=new Date-v;console.log("onHide",e,this.source,g),this.handleCommonUma(g,{Um_Key_Duration:e})},onUnload:function(){var e=new Date-v;this.handleCommonUma(g,{Um_Key_Duration:e})},mounted:function(){this.setScrollHeight()},methods:h(h({},(0,f.mapActions)(["pluginMallrequestPayment","pluginMallContactsInfo"])),{},{setScrollHeight:function(){var t=this.systemInfo,n=t.statusBarHeight,o=t.system,r=/ios/i.test(o)?44:46;console.log(r,n,"statusBarHeight");var a=e.getSystemInfoSync().windowHeight-r-n-84;this.height=a,console.log(a,"获取子组件高度")},offlineDataTransful:function(){var e=this,t=[],n={users:[]},o=[],r=0;this.offlineList.forEach((function(e){console.log(e,"offlineDataTransful"),r+=Number(e.price),t.push({ticketName:e.nickName||e.ticketName,price:e.price,amount:1});var o={name:e.name,ticket:"",freeList:[{ticketName:e.nickName||e.ticketName,price:e.price,amount:1}],showPrice:e.price};n.users.push(o)}));var a=u.default.groupBy(this.offlineList,"modelCode");Object.keys(a).forEach((function(t){var n=a[t],r=u.default.nth(n,0),s=u.default.groupBy(n,"certNo"),c=r.ticketName,i=r.modelCode,d={ticketName:c,price:r.price,amount:0,modelCode:i,itemId:r.itemId,wayType:"6",spiltStartTime:r.startTime,spiltEndTime:r.endTime,fsName:e.selectSchedule,orderCertAuthList:[],needConfirm:"F"};Object.keys(s).forEach((function(e){var t=s[e],n=u.default.nth(t,0),o={realName:n.name,ticket:n.ticketName,certType:n.cardType,certNo:n.idCard};d.amount+=1,d.orderCertAuthList.push(o)})),o.push(d)})),r=u.default.round(r,2),this.freeList=t,this.saveOrders=o,this.orderInfo=n,this.totalPrice=r},handleSubmitOrder:function(){var t=this;return(0,a.default)(r.default.mark((function n(){var o,a,s,i,d,l,f,m,h,g,v,y,b,k,C,O,T,P,D,_,N,w;return r.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!t.disabledButton){n.next=2;break}return n.abrupt("return");case 2:return n.next=4,(0,c.getTicketTip)();case 4:if(o=n.sent,"normal"!==t.source||"T"!==o.open||t.selectData!==o.playDate){n.next=8;break}return t.noticeData.content='<div style="margin-top: 16px;text-align: center;">'.concat(o.tips,"</div>"),n.abrupt("return");case 8:e.showLoading({title:"加载中",mask:!0}),t.disabledButton=!0,a=t.buyer,s=a.id,i=a.openId,d={};try{l=u.default.head(t.saveOrders).orderCertAuthList,d=u.default.head(l)}catch(e){console.log(e)}return f={id:s,openId:i,mobile:t.phone,credentialNo:d.certNo,credentialType:String(d.certType),nickName:d.realName},m={buyer:f,couponCode:"",startDate:t.selectData,endDate:t.selectData,addTickets:t.addTickets,saveOrders:t.saveOrders,wayType:"6"},u.default.eq(t.isAddBuy,1)&&(m.saveOrders=t.addTickets,m.parentOrderCode=t.parentOrderCode,delete m.addTickets),console.log(m,"orderBody postData---下单参数-----"),n.next=19,(0,c.getTradDsaveOrder)(m);case 19:if(h=n.sent,g=h.data,v=h.success,y=h.message,console.log(m,g,"getTradDsaveOrder ==> 下单参数 ==> 下单结果"),!v){n.next=48;break}return b=g.paySum,k=g.payOrderNo,C=g.orderCode,t.orderCode=C,n.next=29,(0,c.getMerchantPayType)({payOrderNo:k});case 29:return O=n.sent,T=O.channelProductCode,P=O.payType,console.log(T,P,"getMerchantPayType"),n.next=35,(0,c.getOrderToPay)({payOrderNo:k,paySum:b,openId:i,channelProductCode:T,payType:P,extendParamJson:{openId:i,channelProductCode:T}});case 35:if(D=n.sent,console.log(D,"getOrderToPay"),!D.pay){n.next=41;break}return n.next=40,t.pluginMallrequestPayment(D).then((function(){e.showLoading({title:"加载中",mask:!0}),u.default.delay((function(n){console.log(n,D,"支付成功"),t.toOrderPageResult(),e.hideLoading({noConflict:!0})}),4e3,"支付成功后等待4s等待结果同步")})).catch((function(e){console.log(e),t.toOrderPageResult({type:2})}));case 40:return n.abrupt("return",!1);case 41:return e.showLoading({title:"加载中",mask:!0}),n.next=44,(0,c.getMiniProgramTemplate)();case 44:return _=n.sent,u.default.isEmpty(_)||(w=null===(N=u.default.find(_,{templateType:"park-OrderPaySuccessEvent"}))||void 0===N?void 0:N.templateId,p.default.subscription([w])),u.default.delay((function(e){console.log(e,D,"零元支付成功"),t.toOrderPageResult()}),4e3,"不用拉起支付.等待4s等待支付同步"),n.abrupt("return");case 48:e.showToast({title:y,icon:"none"});case 49:case"end":return n.stop()}}),n)})))()},toOrderPageResult:function(t){(0,l.navigateTo)(l.PAGE_PATH.TICKETS_RESULT,h({orderCode:this.orderCode,source:this.source},t),"reLaunch"),e.hideLoading({noConflict:!0})},onClosetTicketCheckModal:function(){e.navigateBack({delta:4}),(0,l.navigateTo)(l.PAGE_PATH.TICKETS_SELECT,{source:"normal"})}})}}).call(this,n("bc2e").default)},"83dc":function(e,t,n){n.r(t);var o=n("7874"),r=n.n(o);for(var a in o)["default"].indexOf(a)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(a);t.default=r.a},aa96:function(e,t,n){(function(e,t){var o=n("4ea4");n("6cdc"),o(n("66fd"));var r=o(n("10ed"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(r.default)}).call(this,n("bc2e").default,n("543d").createPage)}},[["aa96","common/runtime","common/vendor","pages/tickets/common/vendor"]]]);