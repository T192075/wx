var e=require("@babel/runtime/helpers/typeof"),r=require("@babel/runtime/helpers/slicedToArray"),n=require("./request"),a=require("./utils"),t=require("./libs/eval5.min.js"),o=require("./utils/util"),i={},s=require("./platform");var c=(0,o.getSystemInfo)(),l=!1;var u=new Map;module.exports={isLicenseEffective:function(){return l},isLicenseEffectivePromise:function(){return l?Promise.resolve(!0):Promise.reject("license not effective")},setLicense:function(e){var r=wx.getAccountInfoSync().miniProgram.appId,n=(0,a.sha256)(e);return new Promise((function(e,a){wx.request({url:"https://mp-license-api.easyar.com/verify",method:"POST",header:{"content-type":"application/x-www-form-urlencoded"},data:{uuid:n,wxAppId:r},success:function(r){200===r.statusCode&&r.data?0===r.data.code?(l=!0,e({result:"success"})):(console.error(r.data.message),a(r.data.message)):(console.error("connection error"),a("connection error"))},fail:function(e){console.error(e.errMsg),a(e.errMsg)}})}))},pcSetup:function(e,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;if(e&&e.request){if(l){(0,n.setWxApi)(e),r=s.patchCanvas(r),s.setProjectSign(t),i.http.get=s.httpGet,a=Object.assign({touch:new i.TouchDevice(r),graphicsDeviceOptions:{antialias:!1,useDevicePixelRatio:!0,alpha:!0,preserveDrawingBuffer:!1,preferWebGl2:!1}},a);var o=new i.Application(r,a);return o.assets.on("error",(function(e,r){return console.error("asset error",e,r.name)})),{pc:i,app:o,canvas:r}}return console.error("\u65e0\u6548\u7684\u8bb8\u53ef\u8bc1"),{pc:null,app:null,canvas:null}}console.error("pcSetup\u65b9\u6cd5\u5df2\u66f4\u65b0\uff0c\u9700\u4f20\u5165\u5fae\u4fe1api\uff1awx\uff0c\u4f7f\u7528\u65b9\u6cd5\uff1apcSetup(wx, canvas, options, baseUrl, projectSign)")},loadProject:function(e,r,n){return e.on("preload:progress",(function(e){n.onLoading&&n.onLoading(e)})),e.on("preload:end",(function(r){e.off("preload:progress"),n.onLoaded&&setTimeout((function(){return n.onLoaded()}))})),s.setProjectBaseUrl(r),function(e){return new Promise((function(r,n){console.debug((new Date).getTime(),"loading config"),e.configure("config.json",(function(e){console.debug((new Date).getTime(),"config loaded"),e?n(e):r()}))}))}(e).then((function(){return function(e){return new Promise((function(r,n){console.debug((new Date).getTime(),"preloading"),e.preload((function(e){console.debug((new Date).getTime(),"preloaded"),e?n(e):r()}))}))}(e)}))},loadScene:function(e,r){return new Promise((function(n,a){console.debug((new Date).getTime(),"loading scene",r),e.loadScene(r,(function(e,r){console.debug((new Date).getTime(),"scene loaded",r),e?a(e):n(r)}))}))},rotationFromMotion:function(e,n,a){if("android"===c.platform)if(c.version.startsWith("7.")){var t=[-e,-n,-a];e=t[0],n=t[1],a=t[2]}else{var o=[-e,-n,a];e=o[0],n=o[1],a=o[2]}else{var s=[e,n,-a];e=s[0],n=s[1],a=s[2]}var l=[n,e,a].map((function(e){return i.math.DEG_TO_RAD*e})),u=r(l,3),p=u[0],g=u[1],f=u[2],d=[p,g,f].map((function(e){return Math.cos(e/2)})),m=r(d,3),v=m[0],M=m[1],w=m[2],T=[p,g,f].map((function(e){return Math.sin(e/2)})),h=r(T,3),x=h[0],P=h[1],F=h[2],b=new i.Quat(x*M*w+v*P*F,v*P*w-x*M*F,v*M*F-x*P*w,v*M*w+x*P*F),S=new i.Quat(-Math.sqrt(.5),0,0,Math.sqrt(.5));return b.mul(S)},clearScreen:function(e){var r=e.getContext("webgl",{antialias:!1,useDevicePixelRatio:!0,alpha:!0,preserveDrawingBuffer:!1,preferWebGl2:!1});r&&(r.clear(r.COLOR_BUFFER_BIT),r.clear(r.DEPTH_BUFFER_BIT),r.clear(r.STENCIL_BUFFER_BIT))},preloadScene:function(e,r,n){var a;u.has(e)?a=u.get(e):(a={},u.set(e,a)),a.preFileManager||(a.preFileManager=new s.PreFileManager),a.preFileManager.init(e,r,n),a.preFileManager.preload()},preloadKtxs:function(r,n,a,t){var o,i=!1;"object"===e(r)?(i=!0,r=s.patchCanvas(r)):(t=a,a=n,n=r),u.has(n)?o=u.get(n):(o={},u.set(n,o)),o.preTexManager||(o.preTexManager=new s.PreTexManager(i)),o.preTexManager.init(n,a,t),o.preTexManager.preloadKtxs()},pausePreload:function(e){if(u.has(e)){var r=u.get(e);r.preFileManager&&r.preFileManager.enable&&r.preFileManager.pause(),r.preTexManager&&r.preTexManager.enable&&r.preTexManager.pause()}},resumePreload:function(e){if(u.has(e)){var r=u.get(e);r.preFileManager&&r.preFileManager.enable&&r.preFileManager.resume(),r.preTexManager&&r.preTexManager.enable&&r.preTexManager.resume()}},deletePreload:function(e){if(u.has(e)){var r=u.get(e);r.preFileManager&&r.preFileManager.dispose(),r.preTexManager&&r.preTexManager.dispose(),s.deletePreProject(e),u.delete(e)}},clearAllPreload:function(){u.forEach((function(e,r){e.preFileManager&&e.preFileManager.dispose(),e.preTexManager&&e.preTexManager.dispose()})),s.clearPreProjects(),u.clear()},clearProjectStorage:function(e){s.deletePreProject(e)},loadNetworkScript:function(e,r){return new Promise((function(a,o){var i=s.getPreFile(e);i?((0,t.evaluate)(i,r),a()):n.wxapi.request({url:e,responseType:"text",success:function(e){200===e.statusCode?((0,t.evaluate)(e.data,r),a()):o()},fail:function(){console.error("load scirpt error"),o()}})}))},loadScriptFromString:function(e,r){(0,t.evaluate)(e,r)},inject:function(e){Object.keys(i).length||(e&&e.init&&e.init(s),e.pc.platform="wx",i=e.pc)}};