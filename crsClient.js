var e=require("@babel/runtime/helpers/objectSpread2"),t=require("@babel/runtime/helpers/classCallCheck"),n=require("@babel/runtime/helpers/createClass"),s=require("./utils"),i=require("./request"),r={notracking:"true"},a=function(){function e(n,s){t(this,e),this.key=n,this.secret=s}return n(e,[{key:"sign",value:function(e){e=Object.assign({},e,{timestamp:""+(new Date).getTime(),appKey:this.key});var t=Object.keys(e).sort().map((function(t){return"".concat(t).concat(e[t])})).concat(this.secret).join("");return e.signature=(0,s.sha256)(t),e}},{key:"getApiToken",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.key,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.secret,s=(new Date).getTime(),i={expires:3600,timestamp:s,apiKey:t};return new Promise((function(t,s){wx.request({url:"https://uac.easyar.com/token/v2",method:"POST",data:e.sign(i,n),success:function(e){return t(e.data.result.token)},fail:function(e){return s(e)}})}))}},{key:"getCrsToken",value:function(e,t,n){var s={expires:3600,timestamp:(new Date).getTime(),appKey:e};return new Promise((function(e,i){wx.request({url:n,method:"POST",data:sign(s,t),success:function(t){return e(t.data.result.token)},fail:function(e){return i(e)}})}))}}]),e}(),u=function(){function u(e,n,s){var c=this;t(this,u),n&&(0,i.setWxApi)(n),this.config=e,this.crsAppId=e.crsAppId,this.auth=new a(e.accessKey,e.accessSecret),this.crsAppId&&this.auth.getApiToken().then((function(e){c.config.token=e,c.header={"content-type":"application/json",Authorization:c.config.token}})),this.host=e.clientHost,this.requestConfig=Object.assign({},r,s)}return n(u,[{key:"setRequestConfig",value:function(e){console.log("update requestConfig",e),this.requestConfig=Object.assign({},r,e)}},{key:"queryImage",value:function(t){var n=this;t=(0,s.data2base64)(t);var r=e({image:t},this.requestConfig);return this.crsAppId?r.appId=this.crsAppId:r=this.auth.sign(r),new Promise((function(e,t){i.wxapi.request({url:"".concat(n.host,"/search/"),method:"post",header:n.header,data:r,success:function(t){return e(t.data)},fail:function(e){return t(e)}})}))}}]),u}();module.exports=u;