var n=require("./request");module.exports=function(t,e,i,a,c,u){return u&&(0,n.setWxApi)(u),new Promise((function(n,r){var f=e.graphicsDevice.gl,o=function(n){a(0,0),r(n)};e.once("postrender",(function(){var e,r,s,h,d,g,l,v,m,p=[f.drawingBufferWidth,f.drawingBufferHeight],w=p[0],I=p[1];a(w,I);var P=new Uint8Array(w*I*4);f.readPixels(0,0,w,I,f.RGBA,f.UNSIGNED_BYTE,P),d=function(){i.takePhoto({quality:"high",success:function(n){h=n.tempImagePath,wx.getImageInfo({src:h,success:function(n){e=n.width,r=n.height,g()},fail:function(n){o(n)}})},fail:function(n){o(n)}})},g=function(){!function(n,t,e,i,a,c,u,r,f){var o=~~(i/4),s=~~(i/4*2),h=~~(i/4*3),d=i,g=function(i,a,u,o){var s=t(a,u),h=new Uint8ClampedArray(s);f.canvasPutImageData({canvasId:n,data:h,x:0,y:a,width:e,height:u-a,success:function(n){o()},fail:function(n){c&&c(n)}},r)},l=function(n,t,e,i,a){f.canvasToTempFilePath({canvasId:n,fileType:"png",x:0,y:0,width:t,height:e,destWidth:t,destHeight:e,success:function(n){i&&i(n.tempFilePath)},fail:function(n){c&&c(n)}},a)};u?g(0,0,o,(function(){g(0,o,s,(function(){g(0,s,h,(function(){g(0,h,d,(function(){return l(n,e,i,a,r)}))}))}))})):g(0,0,d,(function(){return l(n,e,i,a,r)}))}(t,(function(n,t){return P.slice(w*n*4,w*t*4)}),w,I,(function(n){s=n,l()}),o,!0,c,u)},l=function(){var n=u.createCanvasContext(t,c);if(e/r>=w/I){var i=w/I*r,a=(e-i)/2;n.drawImage(h,a,0,i,r,0,0,w,I)}else{var f=I/w*e,o=(r-f)/2;n.drawImage(h,0,o,e,f,0,0,w,I)}n.save(),n.transform(1,0,0,-1,0,I),n.drawImage(s,0,0,w,I),n.restore(),n.draw(!0,(function(n){v()}))},v=function(){u.canvasToTempFilePath({canvasId:t,fileType:"jpg",x:0,y:0,width:w,height:I,destWidth:w,destHeight:I,success:function(n){m(n.tempFilePath)},fail:o},c)},m=function(t){a(0,0),n(t)},d()}))}))};