var e=require("@babel/runtime/helpers/classCallCheck"),t=require("@babel/runtime/helpers/createClass"),s=require("./utils"),a=require("./request"),i=require("./encoder"),c=function(){function a(t,s){e(this,a),this.key=t,this.secret=s}return t(a,[{key:"sign",value:function(e){var t=Object.assign({},e,{timestamp:(new Date).getTime(),apiKey:this.key}),a=Object.keys(t).sort().map((function(e){return"".concat(e).concat(t[e])})).concat(this.secret).join("");return t.signature=(0,s.sha256)(a),t}}]),a}(),n=function(){function n(t){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:70,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0;e(this,n),r&&(0,a.setWxApi)(r),this.auth=new c(t.accessKey,t.accessSecret),this.localizeHost=t.localizeHost?t.localizeHost:"https://cls-api.easyar.com/localize",this.schemaHost=t.schemaHost?t.schemaHost:"https://aroc-cn1.easyar.com/arpackage/schema",this.cameraParam=t.cameraParam?t.cameraParam:"[523.567, 523.567, 232.833, 319.22]",this.clsAppId=t.clsAppId,this.schemaId=t.schemaId,this.tprofile=t.tprofile?t.tprofile:0,this.clskey=t.clskey,this.requestInterval=s,this.quality=i}return t(n,[{key:"update",value:function(e){this.auth=new c(e.accessKey,e.accessSecret),this.localizeHost=e.localizeHost?e.localizeHost:"https://cls-api.easyar.com/localize",this.schemaHost=e.schemaHost?e.schemaHost:"https://aroc-cn1.easyar.com/arpackage/schema",this.cameraParam=e.cameraParam?e.cameraParam:"[523.567, 523.567, 232.833, 319.22]",this.clsAppId=e.clsAppId,this.schemaId=e.schemaId,this.tprofile=e.tprofile?e.tprofile:0,this.clskey=e.clskey}},{key:"start",value:function(e){this.enable=!1,this.frame=null,this.cbs=e,this.resume()}},{key:"pause",value:function(){this.enable=!1,this.frame=null,this.timeoutID&&(clearTimeout(this.timeoutID),this.timeoutID=null),this.clsTask&&(this.clsTask.abort(),this.clsTask=null)}},{key:"resume",value:function(){this.enable||(this.enable=!0,this._search())}},{key:"stop",value:function(){this.pause(),this.cbs=null}},{key:"setFrame",value:function(e){this.frame=e,this.frameChange=!0}},{key:"_search",value:function(){var e=this;this.enable&&(this.frame&&this.frameChange?(this.frameChange=!1,i.encode(this.frame,(function(t){e.queryImage(t).then((function(t){e.enable&&0==t.statusCode&&e.cbs&&e.cbs.onFound?e.cbs.onFound(t):e.enable&&e.cbs&&e.cbs.onLost&&e.cbs.onLost(t),e.enable&&(e.timeoutID=setTimeout((function(){e.timeoutID=null,e._search()}),e.requestInterval))}),(function(t){e.cbs&&e.cbs.onLost&&e.cbs.onLost(t)}))}),this.quality)):this.enable&&(this.timeoutID=setTimeout((function(){e.timeoutID=null,e._search()}),this.requestInterval)))}},{key:"queryImage",value:function(e){var t=this,i={image:e=(0,s.data2base64)(e),appId:this.clsAppId,cameraParam:this.cameraParam,tprofile:this.tprofile},c=this.auth.sign(i);return new Promise((function(e,s){t.clsTask=a.wxapi.request({url:"".concat(t.localizeHost),method:"POST",data:c,success:function(s){t.clsTask=null,e(s.data)},fail:function(e){t.clsTask=null,s(e)}})}))}},{key:"schemaControl",value:function(e){var t=this.schemaHost+"/"+this.schemaId+"/target/"+e,s=this.auth.sign({appId:this.clskey});return new Promise((function(e,i){a.wxapi.request({url:t,method:"GET",data:s,success:function(t){e(t.data)},fail:function(e){return i(e)}})}))}}]),n}();module.exports=n;