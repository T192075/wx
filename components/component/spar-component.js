var e=require("../../@babel/runtime/helpers/interopRequireDefault")(require("../../@babel/runtime/regenerator")),t=require("../../@babel/runtime/helpers/objectSpread2"),a=require("../../@babel/runtime/helpers/asyncToGenerator"),n=require("../../pc"),r=n.pcSetup,o=n.loadProject,i=n.loadScene,c=n.rotationFromMotion,s=n.setLicense,u=n.loadNetworkScript,l=require("../../index"),p=l.setCurrentCanvas,d=l.cancelLoadProject,h=l.setProjectBaseUrl,v=l.setProjectSign,f=require("../../crsClient"),m=require("../../recognizer"),g=require("../../screenshot"),w=wx.getSystemInfoSync(),S=w.windowWidth,b=w.windowHeight;function x(e){wx.showLoading({title:"".concat((100*e).toFixed(2),"%"),mask:!1})}function y(e){wx.hideLoading(),wx.showModal({title:"\u9519\u8bef",content:e,showCancel:!1})}Component({properties:{wxapi:{type:Object,value:null},projectUrl:{type:String,value:""},sceneFileName:{type:String,value:""},crsConfig:{type:Object,value:null},requestInterval:{type:Number,value:0},targetIds:{type:Array,value:[]},deviceMotion:{type:Object,value:null,observer:function(e,t,a){this.setData({rotation:c(e.alpha,e.beta,e.gamma)})}},loadScripts:{type:Function,value:null},loadNetworkScripts:{type:Object,value:null},setup:{type:Function,value:null},tearDown:{type:Function,value:null},screenshotEnable:{type:Boolean,value:!1},projectSign:{type:String,value:null},license:{type:String,value:null}},data:{canvasWidth:S,canvasHeight:b,canvasStyleWidth:"".concat(S,"px"),canvasStyleHeight:"".concat(b,"px"),cameraLoaded:!1,devicePosition:"back",rotation:null,screenshotWidth:0,screenshotHeight:0},methods:{onCanvasTouchStart:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCanvasTouchMove:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCanvasTouchEnd:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCanvasTouchCancel:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCameraInit:function(e){this.setupScene()},screenshot:function(){var e=this;return g("screenshot",this.app,this.cameraCtx,(function(t,a){e.setData({screenshotWidth:t,screenshotHeight:a})}),this)},setupScene:function(){var e=this;this.data.cameraLoaded||this.setData({cameraLoaded:!0},(function(){e._setupScene()}))},_setupScene:function(){var n=this;return a(e.default.mark((function a(){var c,l,p,d,h,v,g,w,S,b;return e.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.data.wxapi){e.next=3;break}return console.error("\u8bf7\u4f20\u5165\u5fae\u4fe1api"),e.abrupt("return");case 3:if(c=function(e){return new Promise((function(t,a){n.createSelectorQuery().select(e).node().exec((function(e){t(e[0].node)}))}))},!n.data.license){e.next=7;break}return e.next=7,s(n.data.license);case 7:return e.next=9,c("#preview");case 9:l=e.sent,p=r(n.data.wxapi,l,{},"",n.data.projectSign),d=p.pc,h=p.app,v=p.canvas,d&&h&&v&&(n.canvas=v,n.app=h,n.data.setup&&n.data.setup(n),h.on("update",(function(e){g&&n.data.rotation&&g.setRotation(n.data.rotation)})),w=function(){return x(0),o(h,n.data.projectUrl,{onLoading:function(e){x(e)}}).then((function(){return i(h,n.data.sceneFileName)})).then((function(e){if(h.start(),(g=h.root.findByName("Camera")).camera.clearColor=new d.Color(0,0,0,0),g.camera.clearColorBuffer=!0,n.data.loadScripts)n.data.loadScripts(d,h,{screenshot:function(){return n.screenshot()}});else if(n.data.loadNetworkScripts){var a=n.data.projectUrl+"/__game-scripts.js";u(a,Object.assign({pc:d},t(t({},n.data.loadNetworkScripts),{},{console:console,setTimeout:setTimeout,clearTimeout:clearTimeout,setInterval:setInterval,clearInterval:clearInterval})))}wx.hideLoading()}))},S=wx.createCameraContext(),n.cameraCtx=S,n.data.crsConfig?(b=new f(n.data.crsConfig,n.data.wxapi),n.recognizer=new m(b,n.data.requestInterval),n.cameraListener=S.onCameraFrame((function(e){n.recognizer.setFrame(e)})),n.cameraListener.start(),n.recognizer.start({targetFound:function(e){return n.data.targetIds.includes(e.target.targetId)},onFound:function(e){n.recognizer.stop(),w().catch((function(e){console.error(e),y("\u5de5\u7a0b\u52a0\u8f7d\u51fa\u9519")}))}})):w().catch((function(e){console.error(e),y("\u5de5\u7a0b\u52a0\u8f7d\u51fa\u9519")})));case 12:case"end":return e.stop()}}),a)})))()}},attached:function(){var e=this;console.log("component attached"),"devtools"===w.platform&&setTimeout((function(){return e.setupScene()}),200)},detached:function(){console.log("component detached"),d(),this.cameraListener&&this.cameraListener.stop(),this.recognizer&&this.recognizer.stop(),this.data.tearDown&&this.data.tearDown(this),this.app&&this.app.destroy(),p(null),h(null),v(null)},pageLifetimes:{show:function(){console.log("pageLifetimes show"),this.app&&this.secondshow&&(p(this.canvas),h(this.data.projectUrl),v(this.data.projectSign),this.app.tick(),this.app.root.enabled=!0),this.secondshow=!0},hide:function(){console.log("pageLifetimes hide"),this.app&&(this.app.root.enabled=!1),p(null),h(null),v(null)}}});