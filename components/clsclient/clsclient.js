var t=require("../../@babel/runtime/helpers/classCallCheck"),e=require("../../@babel/runtime/helpers/createClass"),i=require("./MultiSwitch"),a=require("./api"),s=require("./Ema"),n=require("../../utils/Sensors"),o=require("../../utils/util"),r=require("../../utils/base64ToArrayBuffer"),c=require("./text.min"),h=require("./config"),l=require("../../pc"),u=require("../../request"),f="devtools"===wx.getSystemInfoSync().platform,d=function(){function i(e){t(this,i),this.self=e}return e(i,[{key:"run",value:function(){return this.self.fireOnce=!0,this.self.__fire(this.self.deviceMotion)}}]),i}(),p=function(){function i(e){t(this,i),this.self=e}return e(i,[{key:"takePhoto",value:function(t){return this.self.cameraCtx.takePhoto(t)}},{key:"getFrame",value:function(){return this.self.frame}}]),i}();Component({properties:{debug:{type:Boolean,value:f},enableOnce:{type:Boolean,value:!0},location:{type:String,value:""},proxy:{type:Boolean,value:!1},autoLocate:{type:Boolean,value:!1},includePerf:{type:Boolean,value:!1},wxapi:{type:Object,value:null},serverConfig:{type:Object,value:null},license:{type:String,value:null},clsConfig:{type:Object,value:null},minInterval:{type:Number,value:500},running:{type:Boolean,value:!0},requireDeviceMotion:{type:Boolean,value:!0}},data:{canvasW:480,canvasH:640},location:"",lifetimes:{attached:function(){var t=this;this.data.wxapi?(0,u.setWxApi)(this.data.wxapi):(console.error("\u9700\u8981\u4f20\u5165wxapi"),this.triggerEvent("error","\u9700\u8981\u4f20\u5165wxapi")),this.location="",this.__fire=(0,o.throttle)(this.__fire,this.data.minInterval,this),this.loopSwitch=new i.MultiSwitch(["attach","data","camera","canvas","param","show"]),this.loadSwitch=new i.MultiSwitch(["attach","data","camera","canvas"]),this.onSwitch("attach"),this.onSwitch("wait"),this.loadSwitch.registerAllOn((function(){t.triggerEvent("load",{clsClientContext:new d(t),clsCameraContext:new p(t)})})),this.loopSwitch.registerAllOn((function(){return t._beginLoop()})),this.loopSwitch.registerAnyOff((function(){return t._stopLoop()})),this.data.running?this.onSwitch("param"):this.offSwitch("param"),this.deviceMotionSwitch=new i.MultiSwitch(["show","param"]),this.deviceMotionSwitch.registerAllOn((function(){n.sensorDeviceMotion.on("clsclient")})),this.deviceMotionSwitch.registerAnyOff((function(){n.sensorDeviceMotion.off("clsclient")})),this.data.requireDeviceMotion?this.deviceMotionSwitch.on("param"):this.deviceMotionSwitch.off("param"),f&&setTimeout((function(){return t.onCameraInit()})),this.data.clsConfig&&this._loadData(),f&&(this.deviceMotion={alpha:200,beta:-90,gamma:0}),n.sensorDeviceMotion.register("clsclient",(function(e){t.deviceMotion=e}))},detached:function(){this.listener&&this.listener.stop(),n.sensorDeviceMotion.unregister("clsclient"),this.offSwitch("attach")},error:function(t){this.triggerEvent("error",t)}},methods:{onSwitch:function(t){this.loopSwitch.on(t),this.loadSwitch.on(t)},offSwitch:function(t){this.loopSwitch.off(t),this.loadSwitch.off(t)},onCameraInit:function(){var t=this;this.cameraInitDone||(this.cameraInitDone=!0,this.cameraCtx=wx.createCameraContext(),this.listener=this.cameraCtx.onCameraFrame((0,o.throttle)((function(e){if((t.inLoop||t.data.enableOnce)&&!t.busy&&t.canvas){var i=t.canvas;i.width===e.width&&i.height===e.height||(t.setData({canvasW:e.width,canvasH:e.height}),i.width=e.width,i.height=e.height,t.__resetCameraParam());for(var a=new Uint8ClampedArray(e.data),s=[],n=s,o=0,r=[[.5,.5],[.25,.5],[.75,.5],[.5,.25],[.5,.75]];o<r.length;o++){var c=r[o],h=c[0]*e.width,l=c[1]*e.height,u=a[4*(e.width*l+h)],f=a[4*(e.width*l+h)+1],d=a[4*(e.width*l+h)+2];n===s?n=[u,f,d]:n&&(n[0]===u&&n[1]===f&&n[2]===d||(n=!1))}n||(t.data.requireDeviceMotion?t.deviceMotion&&t.__setFrame(e):t.__setFrame(e))}}),this.data.minInterval,this)),this.listener.start(),this.onSwitch("camera"),wx.createSelectorQuery().in(this).select("#capture").fields({node:!0,size:!0}).exec((function(e){var i=e[0].node,a=i.getContext("2d");i.width=t.data.canvasW,i.height=t.data.canvasH,t.canvas=i,t.context=a,t.__resetCameraParam(),t.onSwitch("canvas")})))},_loadData:function(){var t=this;this.data.serverConfig&&(0,h.setClsConfig)(this.data.serverConfig),this.config={apiKey:this.data.clsConfig.apiKey,apiSecret:this.data.clsConfig.apiSecret,ocKey:this.data.clsConfig.ocKey,ocSecret:this.data.clsConfig.ocSecret,schemaId:this.data.clsConfig.schemaId},this.clsdata={schema:void 0,clsAppId:void 0,ema:void 0,emc:void 0,clsVersion:void 0,mapIds:void 0,manifestMap:{}};var e=this.data.license?(0,l.setLicense)(this.data.license):(0,l.isLicenseEffectivePromise)(),i=a.api.getMaps(this.config.schemaId,this.config.ocKey,this.config.ocSecret).then((function(e){t.clsdata.schema=e.result,t.clsdata.clsAppId=JSON.parse(t.clsdata.schema.arcloudIdToStart)[0],t.clsdata.mapIds=t.clsdata.schema.arBindings.map((function(t){return t.target}))})),n=i.then((function(){if(t.clsdata.schema.emaFile){var e=t.clsdata.schema.emaFile;return t.data.proxy&&(e=e.replace(/https:\/\/aroc\-(\w+)\.easyar\.com\/(.*)$/,"https://wl-api-proxy.easyar.com/oc/$1/$2")),a.api.request(e,"GET",{},{},null).then((function(e){t.clsdata.ema=e;var i=(0,s.cubeListsFromEma)(e),a=i.clusters,n=i.blocks,o=i.maps;t.clsdata.emaClusters=a,t.clsdata.emaBlocks=n,t.clsdata.emaMaps=o}))}})),o=i.then((function(){return a.api.getClsInfoAnonymous(t.clsdata.clsAppId)})).then((function(e){t.clsdata.clsVersion=e.version.charAt(0)})),r=i.then((function(){return Promise.all(t.clsdata.mapIds.map((function(e){return a.api.getManifest(t.config.schemaId,e,t.config.ocKey,t.config.apiKey,t.config.apiSecret).then((function(i){if(i.result&&i.result.manifest){var a=JSON.parse(i.result.manifest);a&&a.contents&&a.contents.length&&(t.clsdata.manifestMap[e]=(0,s.cubesFromManifest)(a))}}))})))})),c=a.api.getToken(this.config.apiKey,this.config.apiSecret);Promise.all([e,n,o,r,c]).then((function(){t.onSwitch("data")})).catch((function(e){console.log(e),t.triggerEvent("error",e)}))},_onLocationUpdate:function(){var t=this;this.data.autoLocate&&(this._locationUpdate_started||(this._locationUpdate_started=!0,wx.onLocationChange(this._onLocationChange=function(e){var i=e.longitude,a=e.latitude,s=e.altitude,n=e.horizontalAccuracy,o=e.verticalAccuracy;t.location=JSON.stringify({longitude:i,latitude:a,altitude:s,horizontalAccuracy:n,verticalAccuracy:o})}),wx.startLocationUpdate()))},_offLocationUpdate:function(){this.data.autoLocate&&this._locationUpdate_started&&(this._locationUpdate_started=!1,wx.offLocationChange(this._onLocationChange),this._onLocationChange=null,wx.stopLocationUpdate())},_beginLoop:function(){this.inLoop=!0,this.busy=!1,this._onLocationUpdate()},_stopLoop:function(){this.request&&this.request.abort(),this.inLoop=!1,this.busy=!1,this._offLocationUpdate()},__setFrame:function(t){this.busy||(this.frame=t,this.__trigger())},__trigger:function(){this.inLoop?this.__fire(this.deviceMotion):this.fireOnce&&(this.fireOnce=!1,this.__fire(this.deviceMotion))},__fire:function(t){var e=this;if(this.busy)return!1;this.busy=!0;var i={};i.startTime=(new Date).getTime();var s=void 0;return a.api.getToken(this.config.apiKey,this.config.apiSecret).then((function(t){return s=t})).then((function(t){return e.__compress()})).then((function(t){i.base64Time=(new Date).getTime();var a=e.__composeRequestFile(t,s);return i.requestTime=(new Date).getTime(),e.__sendClsRequest(a)})).then((function(a){i.responseTime=(new Date).getTime(),e.__clsResult(a,t,i)})).catch((function(t){t&&"request:fail abort"===t.errMsg||e.__clsError(t,i)})).then((function(){e.busy=!1})),!0},__compress:function(){var t=this;return new Promise((function(e,i){var a=t.canvas,s=t.context,n=s.createImageData(t.frame.width,t.frame.height);n.data.set(new Uint8ClampedArray(t.frame.data)),s.putImageData(n,0,0),e(a.toDataURL("image/jpeg",.7).substr(23))}))},__composeRequestFile:function(t,e){var i={appId:this.clsdata.clsAppId,cameraParam:this.cameraParam},a=this.data.location&&this.data.location.indexOf("{")>-1?this.data.location:this.location;a&&(i.location=a),this.data.debug&&console.log("params",i),this.data.includePerf&&(i.tprofile=1);var s=(0,r.base64ToArrayBuffer)(t),n=Object.keys(i).map((function(t){return"\r\n--XXX"+'\r\nContent-Disposition: form-data;name="'.concat(t,'"')+"\r\n\r\n"+i[t]})).join("")+'\r\n--XXX\r\nContent-Disposition: form-data;name="image"; filename="image.jpg"\r\nContent-Type: application/octet-stream\r\nContent-Transfer-Encoding: binary\r\n\r\n',o=new c.text.TextEncoder,l=o.encode(n),u=new Uint8Array(s),f=o.encode("\r\n--XXX--"),d=new Uint8Array(l.length+u.length+f.length);d.set(l,0),d.set(u,l.length),d.set(f,l.length+u.length);var p=d.buffer,m=this.clsdata.clsVersion;return{url:(0,h.getClsUrl)(m),data:p,header:{"content-type":"multipart/form-data; boundary=XXX",Authorization:e}}},__sendClsRequest:function(t){var e=this;return new Promise((function(i,a){var s=Object.assign({method:"POST",success:function(t){i(t.data)},fail:function(t){a(t)},complete:function(){e.request=void 0}},t);e.request=u.wxapi.request(s)}))},__clsResult:function(t,e,i){var a={};if(a.statusCode=t.statusCode,a.msg=t.msg,this.data.includePerf&&(a.clientPerf=i,t.perf&&(a.serverPerf=t.perf)),t.timestamp&&(a.timestamp=t.timestamp),0===t.statusCode){var s=t.result[0];a.result=s;var n=[];if(s.mapId&&this.clsdata.manifestMap[s.mapId]){var r=this.clsdata.manifestMap[s.mapId],c=(0,o.processPoseSchema)(s.pose),h=(0,o.processPoseCamera)(s.pose);n.push({type:"manifest",contents:r,pose:s.pose,worldTransform:c,cameraTransform:h})}if(s.mapId&&this.clsdata.emaMaps){var l=this.clsdata.emaMaps[s.mapId];if(l&&l.length){var u=(0,o.processPoseSchema)(s.pose),f=(0,o.processPoseCamera)(s.pose);n.push({type:"map",contents:l,pose:s.pose,worldTransform:u,cameraTransform:f})}}if(s.block&&s.block.id&&this.clsdata.emaBlocks){var d=this.clsdata.emaBlocks[s.block.id];if(d&&d.length){var p=(0,o.processPoseSchema)(s.pose),m=(0,o.processPoseCamera)(s.pose);n.push({type:"block",contents:d,pose:s.pose,worldTransform:p,cameraTransform:m})}}if(s.cluster&&s.cluster.id&&this.clsdata.emaClusters){var g=this.clsdata.emaClusters[s.cluster.id];if(g&&g.length){var v=(0,o.processPoseSchema)(s.pose),w=(0,o.processPoseCamera)(s.pose);n.push({type:"cluster",contents:g,pose:s.cluster.pose,worldTransform:v,cameraTransform:w})}}a.worlds=n,this.data.requireDeviceMotion&&e&&(a.deviceMotion=e)}this.triggerEvent("result",a)},__clsError:function(t,e){var i={};i.error=t,i.msg=t.errMsg,this.data.includePerf&&(i.clientPerf=e),this.triggerEvent("result",i)},__resetCameraParam:function(){var t=this.canvas,e=[544,544],i=t.height/640,a=[e[0]*i,e[1]*i],s=[t.width/2,t.height/2];this.cameraParam="["+a[0]+","+a[1]+","+s[0]+","+s[1]+"]"}},observers:{clsConfig:function(t){!t||this.clsConfigLoadKey&&this.clsConfigLoadKey===t.apiKey||(this.clsConfigLoadKey=t.apiKey,this._loadData())},running:function(t){this.loopSwitch&&(t?this.onSwitch("param"):this.offSwitch("param"))},requireDeviceMotion:function(t){this.deviceMotionSwitch&&(t?this.deviceMotionSwitch.on("param"):this.deviceMotionSwitch.off("param"))}},pageLifetimes:{show:function(){this.onSwitch("show"),this.listener&&this.listener.start(),this.deviceMotionSwitch.on("show")},hide:function(){this.offSwitch("show"),this.deviceMotionSwitch.off("show")}}});