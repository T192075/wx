var e=require("../../@babel/runtime/helpers/interopRequireDefault"),t=require("../../@babel/runtime/helpers/objectSpread2"),a=e(require("../../@babel/runtime/regenerator")),o=require("../../@babel/runtime/helpers/asyncToGenerator"),i=require("../../utils/Sensors"),n=require("../../pc"),r=require("../../request"),s=e(require("../../libs/WxVideoDecoder")),c=require("../../pc"),l=c.pcSetup,u=c.loadProject,d=c.rotationFromMotion,h=c.loadScene,p=c.setLicense,v=c.loadNetworkScript,m=require("../../index"),g=m.setCurrentCanvas,f=m.cancelLoadProject,w=m.setProjectBaseUrl,x=m.setProjectSign,M=wx.getSystemInfoSync(),S=M.windowWidth,y=M.windowHeight;function b(e){wx.showLoading({title:"".concat((100*e).toFixed(2),"%"),mask:!1})}var P=1;Component({properties:{debug:{type:Boolean,value:!1},license:{type:String,value:null},wxapi:{type:Object,value:null},projectUrl:{type:String,value:""},sceneFileName:{type:String,value:""},loadScripts:{type:Function,value:null},loadNetworkScripts:{type:Object,value:null},showLoading:{type:Boolean,value:!0},cameraMode:{type:String,value:"default"},customParams:{type:Object,value:null},canvasStyleWidth:{type:String,value:"".concat(S,"px")},canvasStyleHeight:{type:String,value:"".concat(y,"px")}},data:{videoSrc:null},methods:{onSourceVideoMetaDataLoaded:function(e){var t=this;return o(a.default.mark((function o(){var i,n,r,s,c;return a.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(i=e.detail,i.duration,n=i.width,r=i.height,t.decoder){a.next=3;break}return a.abrupt("return");case 3:return a.next=5,t.decoder.init(t);case 5:t.decoder.setInputSize(n,r),s=n,c=r,t.setData({outputWidth:s,outputHeight:c}),t.decoder.setOutputSize(s,c),t.decoder.start(t.onFrameReady.bind(t));case 10:case"end":return a.stop()}}),o)})))()},onFrameReady:function(e){if(this._texture||(this._texture=new this.pc.Texture(this.app.graphicsDevice,{width:e.width,height:e.height,format:this.pc.PIXELFORMAT_R8_G8_B8_A8}),this._texture.magFilter=this.pc.FILTER_LINEAR,this._texture.minFilter=this.pc.FILTER_LINEAR,this._texture.addressU=pc.ADDRESS_CLAMP_TO_EDGE,this._texture.addressV=pc.ADDRESS_CLAMP_TO_EDGE,this.app.fire("setVideoTexture",this._texture)),this.isupload){var t=new Uint8ClampedArray(e.data);this._texture.lock().set(t),this._texture.unlock()}this.isupload=!this.isupload},onCanvasTouchStart:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCanvasTouchMove:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCanvasTouchEnd:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},onCanvasTouchCancel:function(e){this.canvas&&this.canvas.dispatchTouchEvent(e)},setupScene:function(){var e=this;return o(a.default.mark((function o(){var i,c,d,m,g,f;return a.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(e.data.wxapi){a.next=6;break}return console.error("\u8bf7\u4f20\u5165\u5fae\u4fe1api"),e.triggerEvent("error","\u9700\u8981\u4f20\u5165wxapi"),a.abrupt("return");case 6:(0,r.setWxApi)(e.data.wxapi);case 7:return e.triggerEvent("loadProgress",{stage:"canvas"}),i=function(t){return new Promise((function(a,o){e.createSelectorQuery().select(t).node().exec((function(e){a(e[0].node)}))}))},a.next=11,e.data.license?p(e.data.license):(0,n.isLicenseEffectivePromise)();case 11:return a.next=13,i("#preview");case 13:c=a.sent,d=l(e.data.wxapi,c,{},"",e.data.projectSign),m=d.pc,g=d.app,f=d.canvas,m&&g&&f&&(e.canvas=f,e.app=g,e.pc=m,g.on("videoplayer",(function(t){e.setData({videoSrc:t}),e.decoder=new s.default("source","decoding"),e.decoder.init(e)})),function(){return e.data.showLoading&&b(0),e.triggerEvent("loadProgress",{stage:"project"}),u(g,e.data.projectUrl,{onLoading:function(t){e.triggerEvent("loadProgress",{stage:"preload",progress:t}),e.data.showLoading&&b(t)}}).then((function(){if(e.triggerEvent("loadProgress",{stage:"script"}),e.data.loadScripts&&e.data.loadScripts(m,g),e.data.loadNetworkScripts){var a=e.data.projectUrl+"/__game-scripts.js";return v(a,t(t({pc:m},e.data.loadNetworkScripts),{},{console:console,setTimeout:setTimeout,clearTimeout:clearTimeout,setInterval:setInterval,clearInterval:clearInterval}))}return Promise.resolve()})).then((function(){return e.triggerEvent("loadProgress",{stage:"scene"}),h(g,e.data.sceneFileName)})).then((function(t){var a=g.root.findByName("Camera");switch(a.camera.clearColor=new m.Color(0,0,0,0),a.camera.clearColorBuffer=!0,e.camera=a,e.triggerEvent("loadProgress",{stage:"camera",pc:m,app:g,camera:a}),e.data.cameraMode){case"default":e.data.customParams={camera:{position:null,rotation:null,quat:null,useDeviceMotion:!1,deviceMotion:null},root:{position:null,euler:null,quat:null,scale:null,lookAtCamera:!1}};break;case"deviceMotion":case"devicemotion":e.data.customParams={camera:{position:null,rotation:null,quat:null,useDeviceMotion:!0,deviceMotion:null},root:{position:null,euler:null,quat:null,scale:null,lookAtCamera:!1}};break;case"custom":var o=e.data.customParams;(o=o||{}).camera=Object.assign({position:null,rotation:null,useDeviceMotion:!1},o.camera||{}),o.root=Object.assign({position:null,rotation:null,scale:null,lookAtCamera:!1},o.root||{}),e.data.customParams=o}var i=e.data.customParams;console.log("effective camera customParams",e.data.customParams),a.reparent(g.root);var n=i.camera.position,r=i.camera.rotation;n&&a.setLocalPosition(n.x,n.y,n.z),r&&e.camera.setRotation((new e.pc.Quat).setFromMat4(r));var s=g.root.children[0];if(i.root.rootName){var c=g.root.findByName(i.root.rootName);c&&(s=c)}var l=i.root.position,u=i.root.euler,d=i.root.quat,h=i.root.scale;l&&s.setLocalPosition(l.x,l.y,l.z),u&&s.setLocalEulerAngles(u.x,u.y,u.z),d&&s.set(d.x,d.y,d.z,d.w),h&&s.setLocalScale(h.x,h.y,h.z),i.root.lookAtCamera&&(s.lookAt(n.x,l.y,n.z),s.rotateLocal(0,180,0));var p=g.graphicsDevice.canvas.width,v=g.graphicsDevice.canvas.height;console.log("canvas size",p,v);a.camera.fov=180/Math.PI*2*Math.atan(1/(1.7*Math.max(p/480/(v/640),1))),e.data.showLoading&&wx.hideLoading(),e.triggerEvent("loadProgress",{stage:"app",pc:m,app:g,camera:a}),e.triggerEvent("load",{stage:"app",pc:m,app:g,camera:a}),g.start(),g.on("update",(function(t){return e.update(t)}),e)}))}().catch((function(e){var t;console.error(e),t="\u5de5\u7a0b\u52a0\u8f7d\u51fa\u9519",wx.hideLoading(),wx.showModal({title:"\u9519\u8bef",content:t,showCancel:!1})})));case 16:case"end":return a.stop()}}),o)})))()},setDeviceMotion:function(e){this.deviceMotion=e},update:function(e){switch(this.data.cameraMode){case"default":break;case"deviceMotion":case"devicemotion":if(this.camera&&this.deviceMotion){var t=d(this.deviceMotion.alpha,this.deviceMotion.beta,this.deviceMotion.gamma);if(!this.initRotation){var a=t.clone().invert(),o=this.camera.getRotation();this.initRotation=o.clone().mul(a)}var i=(new this.pc.Quat).mul2(this.initRotation,t);this.camera.setRotation(i)}break;case"custom":var n=this.data.customParams&&this.data.customParams.camera;if(this.camera&&n&&n.useDeviceMotion&&this.deviceMotion){var r=d(this.deviceMotion.alpha,this.deviceMotion.beta,this.deviceMotion.gamma);if(!this.initRotation){var s=n.deviceMotion?n.deviceMotion:this.deviceMotion,c=d(s.alpha,s.beta,s.gamma).clone().invert(),l=new this.pc.Quat;n.rotation&&l.setFromMat4(n.rotation),this.initRotation=l.clone().mul(c)}var u=(new this.pc.Quat).mul2(this.initRotation,r);this.camera.setRotation(u)}}},onShow:function(){i.sensorDeviceMotion.on(this.id),console.log("pageLifetimes show"),this.app&&this.secondshow&&(g(this.canvas),w(this.data.projectUrl),this.app.tick(),this.app.root.enabled=!0),this.secondshow=!0},onHide:function(){i.sensorDeviceMotion.off(this.id),console.log("pageLifetimes hide"),this.app&&(this.app.root.enabled=!1),g(null),w(null)}},lifetimes:{attached:function(){var e=this;this.id="playcanvs_"+P++,i.sensorDeviceMotion.register(this.id,(function(t){return e.setDeviceMotion(t)})),this.onShow(),this.setupScene().catch((function(t){e.triggerEvent("error",t)})),"devtools"===M.platform&&(this.deviceMotion={alpha:200,beta:-90,gamma:0})},detached:function(){i.sensorDeviceMotion.unregister(this.id),console.log("component detached"),f(),this.app&&this.app.destroy(),this.canvas=null,this.app=null,this.pc=null,this.triggerEvent("unload"),g(null),w(null),x(null)}},pageLifetimes:{show:function(){this.onShow()},hide:function(){this.onHide()}}});