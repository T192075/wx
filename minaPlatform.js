var e=require("@babel/runtime/helpers/interopRequireDefault"),t=require("@babel/runtime/helpers/createForOfIteratorHelper"),n=require("@babel/runtime/helpers/inherits"),i=require("@babel/runtime/helpers/createSuper"),r=require("@babel/runtime/helpers/construct"),s=require("@babel/runtime/helpers/toConsumableArray"),a=require("@babel/runtime/helpers/classCallCheck"),o=require("@babel/runtime/helpers/createClass"),u=e(require("./reqMan")),c=require("./request");var l,h,f=function(){function e(){a(this,e)}return o(e,[{key:"removeEventListener",value:function(){Array.prototype.slice.call(arguments)}}]),e}(),d=function(){function e(){a(this,e)}return o(e,[{key:"addEventListener",value:function(){Array.prototype.slice.call(arguments)}},{key:"removeEventListener",value:function(){Array.prototype.slice.call(arguments)}}]),e}(),p=function e(){a(this,e)},g=function e(){a(this,e)},y=function e(){a(this,e)},v=function e(){a(this,e)},k=function e(){a(this,e)},m=function(){function e(){a(this,e)}return o(e,[{key:"addEventListener",value:function(){Array.prototype.slice.call(arguments)}}]),e}(),_=function(){function e(){a(this,e)}return o(e,[{key:"appendChild",value:function(){Array.prototype.slice.call(arguments)}}]),e}(),b=function e(){a(this,e)},w=function e(){a(this,e)},x=function(){function e(){a(this,e)}return o(e,null,[{key:"createObjectURL",value:function(){Array.prototype.slice.call(arguments)}}]),e}(),L=function e(){a(this,e)},T=function e(){a(this,e)},P=function(){function e(t,n,i){a(this,e),this.major=t,this.minor=n,this.patch=i}return o(e,[{key:"compare",value:function(e){return this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch-e.patch}}],[{key:"fromString",value:function(t){return r(e,s(t.split(".").map(Number)))}}]),e}();function j(e){l=e}function S(e){h=e}var E=new Map;function C(e){E.has(e)&&E.delete(e)}function O(){E.clear()}function q(e){if(h&&E.has(h)){var t=E.get(h),n=M(e,!1);return t.has(n)?t.get(n):null}return null}function M(e,t){var n=e;if(!n)return"";if(n.startsWith("http"))return n;if(!l)throw new Error("project base url not set");if(!t){var i=n.indexOf("?t=");i>=0&&(n=n.substr(0,i))}return"".concat(l,"/").concat(n)}var N=new u.default;function A(){N.dispose()}function I(e,t,n){"function"==typeof t&&(n=t,t={});var i="text";for(var r in(e.indexOf(".mp3")>-1||e.indexOf(".mp4")>-1)&&!t.responseType&&(t.responseType="arraybuffer"),t)"responseType"===r&&(i=t.responseType);var s=q(e);if(s)n(null,s);else{var a=M(e,!1);N.pushTask({networkPath:a,responseType:i,method:"GET",before:function(e){},success:function(e){a.indexOf("config.json")<0&&a.indexOf(".mp3")<0&&function(e,t){var n;h&&(E.has(h)?n=E.get(h):(n=new Map,E.set(h,n)),n.set(e,t))}(a,e),n(null,e)},fail:function(e){console.error("pc.http.get error",e),n(e)}})}}module.exports=function(e){var r,s=new(function(e){n(r,d);var t=i(r);function r(){var e;return a(this,r),(e=t.call(this))._head=new _,e}return o(r,[{key:"head",get:function(){return this._head}},{key:"createElement",value:function(e,t){if("script"===e.toLowerCase())return new R;Array.prototype.slice.call(arguments)}}]),r}()),u=new(function(t){n(s,p);var r=i(s);function s(){return a(this,s),r.apply(this,arguments)}return o(s,[{key:"userAgent",get:function(){return e.model}},{key:"maxTouchPoints",get:function(){return 1}}]),s}()),l=new(function(t){n(l,f);var c=i(l);function l(){return a(this,l),c.apply(this,arguments)}return o(l,[{key:"requestAnimationFrame",value:function(e){r||console.error("canvas not patched");var t=r;return r._canvas.requestAnimationFrame((function(){t===r&&e()}))}},{key:"innerHeight",get:function(){if(!r)throw new Error("canvas not patched");return r.height}},{key:"innerWidth",get:function(){if(!r)throw new Error("canvas not patched");return r.width}},{key:"document",get:function(){return s}},{key:"navigator",get:function(){return u}},{key:"devicePixelRatio",get:function(){return e.pixelRatio}}]),l}()),h=function(e){n(r,L);var t=i(r);function r(e){var n;return a(this,r),(n=t.call(this))._type=e.type,n._target=e.target,n._touches=e.touches,n._changedTouches=e.changedTouches,n}return o(r,[{key:"type",get:function(){return this._type}},{key:"target",get:function(){return this._target}},{key:"touches",get:function(){return this._touches}},{key:"changedTouches",get:function(){return this._changedTouches}},{key:"preventDefault",value:function(){Array.prototype.slice.call(arguments)}}]),r}(),N=function(e){n(r,v);var t=i(r);function r(e){var n;return a(this,r),(n=t.call(this))._canvas=e,n._listeners={},n}return o(r,[{key:"addEventListener",value:function(e,t,n){this._listeners.hasOwnProperty(e)||(this._listeners[e]=[]),this._listeners[e].push(t)}},{key:"dispatchTouchEvent",value:function(e){var t=new h(e);return!!this._listeners.hasOwnProperty(t.type)&&(this._listeners[t.type].forEach((function(e){setTimeout((function(){return e(t)}))})),!0)}},{key:"removeEventListener",value:function(e,t,n){if(this._listeners.hasOwnProperty(e)){var i=this._listeners[e].indexOf(t);-1!==i&&(this._listeners[e]=this._listeners[e].splice(i,1))}}},{key:"getContext",value:function(e,t){return this._canvas.getContext(e,t)}},{key:"getBoundingClientRect",value:function(){return{top:0,left:0,width:this.clientWidth,height:this.clientHeight}}},{key:"id",get:function(){return this._canvas._canvasId}},{key:"style",get:function(){return{set width(e){Array.prototype.slice.call(arguments)},set height(e){Array.prototype.slice.call(arguments)}}}},{key:"clientWidth",get:function(){return this._canvas._width}},{key:"clientHeight",get:function(){return this._canvas._height}},{key:"height",get:function(){return this._canvas.height},set:function(e){this._canvas.height=e}},{key:"width",get:function(){return this._canvas.width},set:function(e){this._canvas.width=e}}]),r}();var F=function(e){n(s,y);var t=i(s);function s(){var e;if(a(this,s),e=t.call(this),!r)throw new Error("canvas not patched");return e._img=r._canvas.createImage(),e}return o(s,[{key:"width",get:function(){return this._img.width}},{key:"height",get:function(){return this._img.height}},{key:"src",set:function(e){this._img.src=M(e,!0)}},{key:"onload",set:function(e){this._img.onload=e}},{key:"onerror",set:function(e){this._img.onerror=e}}]),s}(),H=function(e){n(r,e);var t=i(r);function r(){return a(this,r),t.apply(this,arguments)}return r}(F),R=function(e){n(r,m);var t=i(r);function r(){return a(this,r),t.call(this)}return o(r,[{key:"src",set:function(e){var t=this;this._src=e,setTimeout((function(){return t.onload()}))}}]),r}(),W=function(e){n(r,b);var t=i(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return a(this,r),(e=t.call(this))._audio=wx.createInnerAudioContext(),e._listeners={},n&&(e._audio.onPause((function(t){console.debug("audio on pause",t,e._debugString)})),e._audio.onPlay((function(t){console.debug("audio on play",t,e._debugString)})),e._audio.onSeeked((function(t){console.debug("audio on seeked",t,e._debugString)})),e._audio.onSeeking((function(t){console.debug("audio on seeking",t,e._debugString)})),e._audio.onStop((function(t){console.debug("audio on stop",t,e._debugString)})),e._audio.onTimeUpdate((function(t){console.debug("audio on time update",t,e._debugString)})),e._audio.onWaiting((function(t){console.debug("audio on waiting",t,e._debugString)}))),e}return o(r,[{key:"_debugString",get:function(){return"src: ".concat(this._audio.src,", startTime: ").concat(this._audio.startTime,", autoplay: ").concat(this._audio.autoplay,",")+" loop: ".concat(this._audio.loop,", obeyMuteSwitch: ").concat(this._audio.obeyMuteSwitch,", volume: ").concat(this._audio.volume,", ")+" duration: ".concat(this._audio.duration,", currentTime: ").concat(this._audio.currentTime,", paused: ").concat(this._audio.paused,", ")+" buffered: ".concat(this._audio.buffered)}},{key:"addEventListener",value:function(e,t,n){this._listeners.hasOwnProperty(e)||(this._listeners[e]=[]),this._listeners[e].push(t)}},{key:"dispatchEvent",value:function(e){var t=e;return!!this._listeners.hasOwnProperty(t.type)&&(this._listeners[t.type].forEach((function(e){setTimeout((function(){return e(t)}))})),!0)}},{key:"removeEventListener",value:function(e,t,n){if(this._listeners.hasOwnProperty(e)){var i=this._listeners[e].indexOf(t);-1!==i&&(this._listeners[e]=this._listeners[e].splice(i,1))}}},{key:"cloneNode",value:function(e){return this}},{key:"src",set:function(e){var t=this;this._audio.src=M(e,!0),this._audio.onCanplay((function(e){console.debug("audio on canplay",e,t._debugString),t._loaded||(t._audio.play(),t._audio.pause(),t._audio.seek(0),t._loaded=!0),t.dispatchEvent({type:"canplaythrough"})}))}},{key:"onerror",set:function(e){var t=this;this._audio.onError((function(n){console.error("audio on error",n,t._debugString),setTimeout((function(){return e()}))}))}},{key:"onended",set:function(e){var t=this;this._audio.onEnded((function(n){console.debug("audio on ended",n,t._debugString),setTimeout((function(){return e()}))}))}},{key:"volume",set:function(e){this._audio.volume=e}},{key:"loop",set:function(e){this._audio.loop=e}},{key:"autoplay",set:function(e){this._audio.autoplay=e}},{key:"startTime",set:function(e){this._audio.startTime=e}},{key:"playbackRate",set:function(e){this._audio.playbackRate=e}},{key:"duration",get:function(){return this._audio.duration}},{key:"currentTime",get:function(){return this._audio.currentTime}},{key:"paused",get:function(){return this._audio.paused}},{key:"pause",value:function(){console.debug("audio pause",this._debugString),this._audio.pause()}},{key:"seek",value:function(e){console.debug("audio seek",this._debugString),this._audio.seek(e)}},{key:"stop",value:function(){console.debug("audio stop",this._debugString),this._audio.stop()}},{key:"play",value:function(){console.debug("audio play",this._debugString),this._audio.play()}},{key:"destroy",value:function(){this._audio.destroy()}}]),r}(),U=function(e){n(s,T);var r=i(s);function s(){var e;return a(this,s),(e=r.call(this)).enable=!1,e}return o(s,[{key:"init",value:function(e,t,n){this.enable=!0,this.paused=!1,this.allNum=0,this.curNum=0,this.running=0,this.runningMax=5,this.tasks=[],this.alreadyLoads=[],this.url=t,this.callback=n,this.normalFiles=new Set,this.ktxs=new Set,E.has(e)?this.preProject=E.get(e):(this.preProject=new Map,E.set(e,this.preProject))}},{key:"dispose",value:function(){this.enable=!1,this.paused=!1,this.url=null,this.callback=null,this.normalFiles.clear(),this.ktxs.clear(),this.preProject=null,this.allNum=0,this.curNum=0,this.running=0,this.runningMax=5,this.tasks.splice(0,this.tasks.length),this.alreadyLoads.splice(0,this.alreadyLoads.length)}},{key:"pause",value:function(){this.paused=!0}},{key:"resume",value:function(){if(this.paused)for(this.paused=!1;this.running<this.runningMax&&this.tasks.length>0;)this.run()}},{key:"stop",value:function(){this.dispose()}},{key:"run",value:function(){this.enable&&!this.paused&&(this.running>=this.runningMax||0!==this.tasks.length&&(this.running+=1,this.tasks.shift()()))}},{key:"pushTask",value:function(e){this.tasks.push(e),this.run()}},{key:"afterLoader",value:function(){var e=this;this.running-=1,this.curNum++,this.curNum>=this.allNum&&this.callback&&this.callback(),setTimeout((function(t){return e.run()}))}},{key:"preload",value:function(){var e=this,t=this.url+"/config.json";c.wxapi.request({url:t,responseType:"text",success:function(t){e.readConfig(t.data)},fail:function(){console.error("config request error!")}})}},{key:"readConfig",value:function(e){var t=wx.getSystemInfoSync().platform;if(e.scenes)for(var n=0;n<e.scenes.length;n++){var i=e.scenes[n].url;this.normalFiles.add(i)}for(var r in e.assets){var s=e.assets[r].file,a=e.assets[r].type;if(s)if("texture"==a||"font"==a||"material"==a)s.variants&&("ios"==t&&s.variants.pvr&&s.variants.pvr.url?this.ktxs.add(s.variants.pvr.url):"android"==t&&s.variants.etc1&&s.variants.etc1.url&&this.ktxs.add(s.variants.etc1.url));else if(s.url){var o=s.url.lastIndexOf(".");if(o>=0){var u=s.url.substr(o+1).toLowerCase();"json"!=u&&"js"!=u||this.normalFiles.add(s.url)}}}this.allNum=this.normalFiles.size+this.ktxs.size,this.allNum>0?(this.preloadNormalFiles(),this.preloadKtxs()):this.callback&&this.callback()}},{key:"preloadNormalFiles",value:function(){var e,n=this,i=t(this.normalFiles);try{var r=function(){var t=e.value;n.pushTask((function(){var e=n.url+"/"+t;n.alreadyLoads.indexOf(e)<0&&!n.preProject.has(e)?(n.alreadyLoads.push(e),c.wxapi.request({url:e,responseType:"text",success:function(t){n.enable&&n.preProject.set(e,t.data)},fail:function(e){console.debug("load file error",+e)},complete:function(){n.afterLoader()}})):n.afterLoader()}))};for(i.s();!(e=i.n()).done;)r()}catch(e){i.e(e)}finally{i.f()}}},{key:"preloadKtxs",value:function(){var e,n=this,i=t(this.ktxs);try{var r=function(){var t=e.value;n.pushTask((function(){var e=n.url+"/"+t;n.alreadyLoads.indexOf(e)<0&&!n.preProject.has(e)?(n.alreadyLoads.push(e),c.wxapi.request({url:e,responseType:"arraybuffer",success:function(t){n.enable&&n.preProject.set(e,t.data)},fail:function(e){console.debug("load ktx error",e)},complete:function(){n.afterLoader()}})):n.afterLoader()}))};for(i.s();!(e=i.n()).done;)r()}catch(e){i.e(e)}finally{i.f()}}}]),s}(),B=function(e){n(r,e);var t=i(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return a(this,r),(e=t.call(this)).includeImage=n,e}return o(r,[{key:"init",value:function(e,t,n){this.enable=!0,this.paused=!1,this.allNum=0,this.curNum=0,this.running=0,this.runningMax=5,this.tasks=[],this.alreadyLoads=[],this.urls=t,this.callback=n,E.has(e)?this.preProject=E.get(e):(this.preProject=new Map,E.set(e,this.preProject))}},{key:"dispose",value:function(){this.enable=!1,this.paused=!1,this.urls.splice(0,this.urls.length),this.callback=null,this.preProject=null,this.allNum=0,this.curNum=0,this.running=0,this.runningMax=5,this.tasks.splice(0,this.tasks.length),this.alreadyLoads.splice(0,this.alreadyLoads.length)}},{key:"preloadKtxs",value:function(){var e=this;if(this.allNum=this.urls.length,this.allNum>0)for(var t=function(t){var n=e.urls[t];if(e.alreadyLoads.indexOf(n)<0&&!e.preProject.has(n)){e.alreadyLoads.push(n);var i=n.lastIndexOf("."),r=n.lastIndexOf("?");if(i>=0){var s=r>-1?n.substring(i+1,r).toLowerCase():n.substr(i+1).toLowerCase();"png"==s||"jpg"==s||"jpeg"==s||"gif"==s?e.includeImage?e.pushTask((function(){var t=new H;t.onload=function(){e.enable&&e.preProject.set(n,t),e.afterLoader()},t.onerror=function(t){console.debug("load image error",t),e.afterLoader()},t.src=n})):e.afterLoader():"dds"==s||"ktx"==s?e.pushTask((function(){c.wxapi.request({url:n,responseType:"arraybuffer",success:function(t){e.enable&&e.preProject.set(n,t.data)},fail:function(e){console.debug("load ktx error",e)},complete:function(){e.afterLoader()}})})):e.afterLoader()}else e.afterLoader()}else e.afterLoader()},n=0;n<this.urls.length;n++)t(n);else this.callback&&this.callback()}}]),r}(U);return{sysInfo:e,canIUse:function(){return!("devtools"!==e.platform&&P.fromString(e.version).compare(P.fromString("7.0.7"))<0)},getCanvasWidth:function(){return r.width},getCanvasHeight:function(){return r.height},window:l,Blob:w,URL:x,Element:g,HTMLImageElement:F,HTMLCanvasElement:N,HTMLVideoElement:k,HTMLScriptElement:R,Image:H,Audio:W,PreFileManager:U,PreTexManager:B,setCurrentCanvas:function(e){r=e},patchCanvas:function(e){return r=new N(e)},setProjectBaseUrl:j,setProjectSign:S,httpGet:I,getPreFile:q,deletePreProject:C,clearPreProjects:O,cancelLoadProject:A}};